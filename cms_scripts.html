<script>
// ========= ENV, MENU, NAV =========
const RAW_MENU = (typeof serverEnv !== 'undefined' && serverEnv.MENU_CONFIG) ? serverEnv.MENU_CONFIG : [
  { key:'dashboard',  title:'Tổng quan' },
  { key:'customers',  title:'Khách hàng' },
  { key:'loans',      title:'Hợp đồng' },
  { key:'loanmgr',    title:'Quản lý khoản vay/Thanh toán' },
  { key:'payhistory', title:'Lịch sử thanh toán' },
  { key:'crm',        title:'CRM' },
  { key:'telegram',   title:'Nhóm Telegram' },
  { key:'reports',    title:'Báo Cáo' },
  { key:'settings',   title:'Cấu Hình' },
  { key:'account',    title:'Cài đặt' }
];
// Chuẩn hóa minimal để không vỡ code cũ:
const MENU = RAW_MENU.map(m => ({
  key: m.key,
  title: m.title || m.name || m.key,
  icon: m.icon || '' // để dành nếu sau này muốn hiện biểu tượng
}));

const AUTH_STATE = { ok:false, principal:'', mode:'' };

function setAuthState(ok, meta){
  AUTH_STATE.ok = !!ok;
  AUTH_STATE.mode = ok ? (meta?.mode || (meta?.menus ? 'local' : '')) : '';
  AUTH_STATE.principal = ok ? (meta?.display || meta?.principal || '') : '';

  const blocker = document.getElementById('login_blocker');
  if (blocker) blocker.classList.toggle('hidden', AUTH_STATE.ok);
  if (document.body) document.body.classList.toggle('needs-login', !AUTH_STATE.ok);

  const loginBtn = document.getElementById('btn_open_login');
  if (loginBtn) loginBtn.classList.toggle('hidden', AUTH_STATE.ok);

  const logoutBtn = document.getElementById('btn_logout');
  if (logoutBtn) logoutBtn.classList.toggle('hidden', !AUTH_STATE.ok);

  const status = document.getElementById('auth_status');
  if (status){
    const txt = AUTH_STATE.ok
      ? ('Đã đăng nhập' + (AUTH_STATE.principal ? ': ' + AUTH_STATE.principal : ''))
      : 'Chưa đăng nhập';
    status.textContent = txt;
    status.classList.toggle('muted', !AUTH_STATE.ok);
  }

  if (!AUTH_STATE.ok) {
    showLoginDialog();
  }
}

function showLoginDialog(){
  const dlg = document.getElementById('dlg_login');
  if (!dlg) return;
  if (dlg.classList?.contains('modal-overlay')){
    dlg.classList.add('show');
  } else if (typeof dlg.showModal === 'function'){
    if (!dlg.open) dlg.showModal();
  } else {
    dlg.setAttribute('open', 'true');
    dlg.classList.add('show');
  }
  const user = document.getElementById('login_user');
  if (user){
    setTimeout(()=>{ user.focus(); user.select(); }, 0);
  }
}

function closeLoginDialog(){
  const dlg = document.getElementById('dlg_login');
  if (!dlg) return;
  if (dlg.classList?.contains('modal-overlay')){
    dlg.classList.remove('show');
  } else if (typeof dlg.close === 'function'){
    dlg.close();
  } else {
    dlg.removeAttribute('open');
    dlg.classList.remove('show');
  }
}


function renderMenu(){
  const box = document.getElementById('menu');
  if (!box) return;
  box.innerHTML = '';
  MENU.forEach(m => {
    const b = document.createElement('button');
    b.className = 'tabbtn';
    // nếu có icon (text), đặt trước title; có thể dùng emoji hoặc tên icon bạn map sẵn
    b.innerHTML = m.icon ? `<span class="ico">${m.icon}</span> ${m.title}` : m.title;
    b.onclick = () => navigate(m.key);
    b.dataset.key = m.key;
    box.appendChild(b);
  });
}

function navigate(key){
  const target = '#' + key;
  if ((location.hash || '#') === target){
    onRoute();
  } else {
    location.hash = target;
  }
  if (!AUTH_STATE.ok) {
    showLoginDialog();
  }
}
function currentKey(){ return (location.hash||'#dashboard').replace('#',''); }
function setActiveTab(key){
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.key===key));
}
function onRoute(){
  const key = currentKey();
  const keys = MENU.map(m => m.key); // LẤY TỰ ĐỘNG
  keys.forEach(k => {
    const el = document.getElementById('view-' + k);
    if (el) el.classList.toggle('hidden', k !== key);
  });
  setActiveTab(key);
  if (!AUTH_STATE.ok) return;
  // loader theo key (cũ giữ nguyên) — có thể refactor thành map nếu muốn
  if (key==='dashboard')      loadDashboard();
  else if (key==='customers') { bindCustomerImports(); loadCustomers(); }
  else if (key==='loans')     { ensureCustomerDropdown(true); bindLoanImports(); loadLoans(); }
  else if (key==='loanmgr')   { bindLoanMgr(); loadRemindersToday(); refreshPayTypesFromCfg(); }
  else if (key==='payhistory'){}
  else if (key==='settings')  loadSettings();
  else if (key==='account')   loadAccountPrefs();
}


function applyMenuVisibility(){
  if (!AUTH_STATE.ok) return;
  const keys = Array.from(document.querySelectorAll('.tabbtn')).map(b=>b.dataset.key);
  runApi('getVisibleMenusForSession', { keys }, v=>{
    const allowed = new Set(v || keys);
    document.querySelectorAll('.tabbtn').forEach(b=>{
      const ok = allowed.has(b.dataset.key);
      b.style.display = ok ? '' : 'none';
    });
  }, ()=>{});
}

/* ========= Helpers ========= */
const money = n => Number(n||0).toLocaleString('vi-VN');
function toNum(s){ return Number(String(s??'').replace(/[^\d\-]/g,'')) || 0; }
function fmt(v){
  if (!v) return '';
  const d=new Date(v);
  if(!isNaN(d)) return d.toLocaleDateString('vi-VN');
  return v;
}
function toDateInput(v){
  if(!v) return ''; const d=new Date(v); if(isNaN(d)) return '';
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function addMonths(iso, n){
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return '';
  d.setMonth(d.getMonth() + Number(n || 0));
  return toDateInput(d);
}
function hmap(headers){ const m={}; (headers||[]).forEach((h,i)=> m[String(h).trim()]=i); return m; }
const pick=(row, idx)=> (idx>=0 && idx!=null) ? row[idx] : '';
function isInThisWeek(dateStr){
  if(!dateStr) return false;
  const d = new Date(dateStr); if(isNaN(d)) return false;
  const now = new Date();
  const first = new Date(now); 
  const day = first.getDay() || 7;
  first.setDate(first.getDate() - day + 1);
  first.setHours(0,0,0,0);
  const last = new Date(first); last.setDate(first.getDate()+6); last.setHours(23,59,59,999);
  return d >= first && d <= last;
}

function renderTableRows(tbody, rows, fallbackCols){
  if (!tbody) return;
  tbody.innerHTML = '';
  const cols = fallbackCols || (tbody.closest('table')?.tHead?.rows?.[0]?.cells?.length) || 1;
  if (!rows || !rows.length){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = cols;
    td.className = 'muted';
    td.textContent = 'Chưa có dữ liệu';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }
  rows.forEach(row=>{
    const tr = document.createElement('tr');
    row.forEach(val=>{
      const td = document.createElement('td');
      td.textContent = val;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ========= DASHBOARD ========= */
function loadDashboard(){
  runApi('getAppConfig', {}, cfg=>{
    const show = cfg?.showDashboardKpis !== false;
    const wrap = document.getElementById('dashboard_kpis');
    const info = document.getElementById('dashboard_kpis_hidden');
    if (wrap) wrap.classList.toggle('hidden', !show);
    if (info) info.classList.toggle('hidden', show);
    if (show){
      runApi('getDashboardKpis_api', {}, data=>{
        if (!data) return;
        const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
        setText('kpi_fund',          money(data.fund));
        setText('kpi_amount',        money(data.totalLoanAmount));
        setText('kpi_fund_left',     money(data.fundLeft));
        setText('kpi_paid_goc',      money(data.paidPrincipal));
        setText('kpi_paid_lai',      money(data.paidInterest));
        setText('kpi_paid_phi',      money(data.paidFee));
        setText('kpi_cus_total',     money(data.totalCustomers));
        setText('kpi_cus_active',    money(data.activeCustomers));
        setText('kpi_loans',         money(data.totalLoans));
        setText('kpi_loans_inactive',money(data.inactiveLoans));
        const actEl=document.getElementById('kpi_loans_active'); if (actEl) actEl.textContent = money(data.activeLoans);
      }, ()=>{});
    }
  }, ()=>{});

  loadDashboardWeekBlocks();
}

function loadDashboardWeekBlocks(){
  const limit = Number(document.getElementById('dash_limit')?.value || 5);
  runApi('listRecentLoans_api', { limit }, res=>{
    const tb=document.getElementById('dash_loans_week');
    const rows = (res?.rows||[]).map(o=>[
      o.id,
      o.name||'',
      fmt(o.start),
      money(o.amount),
      o.status || ''
    ]);
    renderTableRows(tb, rows, 5);
  }, ()=>{});

  runApi('listRecentPayments_api', { limit }, res=>{
    const tb=document.getElementById('dash_pays_week');
    const rows = (res?.rows||[]).map(o=>[
      fmt(o.date),
      o.loan || '',
      o.type || '',
      money(o.amount)
    ]);
    renderTableRows(tb, rows, 4);
  }, ()=>{});

  const todayISO = new Date().toISOString().slice(0,10);
  runApi('getRemindersToday', { todayISO }, rem=>{
    const dueT  = document.getElementById('dash_due_today');
    const closT = document.getElementById('dash_close_today');
    const dueRows = (rem?.dueToday||[]).map(o=>[
      o.id,
      o.name || '',
      o.k || '',
      fmt(o.due)
    ]);
    const closeRows = (rem?.closeToday||[]).map(o=>[
      o.id,
      o.name || '',
      fmt(o.close),
      o.status || ''
    ]);
    renderTableRows(dueT, dueRows, 4);
    renderTableRows(closT, closeRows, 4);
  }, ()=>{});
}

/* ========= KHÁCH HÀNG ========= */
function loadCustomers(page=1){
  const q = (document.getElementById('cus_search')?.value || '').trim();
  runApi('listRecords', {tableKey:'CUSTOMERS', page, q}, res=>{
    const H = hmap(res.headers||[]);
    const idIdx   = (H['ID Khách'] ?? H['IDVC'] ?? H['ID'] ?? 0);
    const nameIdx = (H['Tên'] ?? H['TenKH'] ?? H['Name'] ?? -1);
    const phoneIdx= (H['SĐT'] ?? H['Phone'] ?? -1);
    const emailIdx= (H['Email'] ?? -1);
    const noteIdx = (H['Ghi chú'] ?? H['Note'] ?? -1);

    const tb=document.getElementById('cus_rows'); if(!tb) return;
    tb.innerHTML='';
    const rows = res.rows || [];
    const total = res.total ?? rows.length ?? 0;
    const ttlEl = document.getElementById('cus_total');
    if (ttlEl) ttlEl.textContent='Danh sách khách hàng — Tổng ' + total + ' bản ghi';

    rows.forEach(r=>{
      const tr=document.createElement('tr');
      [pick(r,idIdx), pick(r,nameIdx), pick(r,phoneIdx), pick(r,emailIdx), pick(r,noteIdx)]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=(v??''); tr.appendChild(td); });
      tb.appendChild(tr);
    });
  }, e=> alert('Không tải được khách hàng: '+(e?.message||e)));
}
function saveCustomerFromDialog(){
  const name  = (document.getElementById('dlg_cus_name')?.value || '').trim();
  const phone = (document.getElementById('dlg_cus_phone')?.value || '').trim();
  const email = (document.getElementById('dlg_cus_email')?.value || '').trim();
  const note  = (document.getElementById('dlg_cus_note')?.value || '').trim();
  const idVal = (document.getElementById('dlg_cus_id')?.value || '').trim();

  const rec = {
    'ID Khách': idVal, 'IDVC': idVal,
    'Tên': name, 'TenKH': name, 'Name': name,
    'SĐT': phone, 'Phone': phone,
    'Email': email,
    'Ghi chú': note, 'Note': note
  };

  runApi('saveRecord', {tableKey:'CUSTOMERS', record:rec}, _=>{
    const dlg=document.getElementById('dlg_customer');
    if(dlg) dlg.close();
    ['dlg_cus_id','dlg_cus_name','dlg_cus_phone','dlg_cus_email','dlg_cus_note']
      .forEach(i=>{ const el=document.getElementById(i); if(el) el.value=''; });
    loadCustomers();
    ensureCustomerDropdown(true);
    alert('Đã lưu khách hàng');
  }, e=> alert('Lỗi lưu khách hàng: ' + (e?.message||e)));
}
function bindCustomerImports(){
  const btnTpl = document.getElementById('imp_cus_tpl');
  const btnRun = document.getElementById('imp_cus_run');
  if (btnTpl && !btnTpl.dataset.bound){
    btnTpl.dataset.bound='1';
    btnTpl.onclick=()=> runApi('getImportTemplate', { tableKey:'CUSTOMERS' }, res=>{
      const link = (res && typeof res === 'object') ? (res.url || res.fileId || res.id) : res;
      alert('Đã tạo file mẫu Khách hàng: ' + (link || '(không rõ)'));
    });
  }
  if (btnRun && !btnRun.dataset.bound){
    btnRun.dataset.bound='1';
    btnRun.onclick=()=>{
      const fileId=(document.getElementById('imp_cus_file')?.value||'').trim();
      if(!fileId) return alert('Nhập Drive File ID');
      runApi('importCustomersFromFile', { fileId }, res=>{
        alert('Nhập/Update khách hàng: '+(res?.updated||0)+' dòng.');
        loadCustomers();
        ensureCustomerDropdown(true);
      }, e=> alert('Lỗi import khách hàng: '+(e?.message||e)));
    };
  }
}

/* ========= DROPDOWN KH ========= */
function ensureCustomerDropdown(force){
  const sels = [
    document.getElementById('dlg_loan_cus_select')
  ].filter(Boolean);
  if (!sels.length) return;
  if (sels.every(s => s.dataset.loaded === '1') && !force) return;

  runApi('listRecords', {tableKey:'CUSTOMERS', page:1, q:''}, res=>{
    const H = hmap(res.headers||[]);
    const idIdx   = H['ID Khách'] ?? H['IDVC'] ?? 0;
    const nameIdx = H['Tên']     ?? H['TenKH'] ?? -1;

    const options = [{id:'', name:'— Chọn khách hàng —'}]
      .concat((res.rows||[]).map(r=>{
        const id = pick(r,idIdx);
        const nm = pick(r,nameIdx) || id;
        return {id, name:nm};
      }));

    sels.forEach(sel=>{
      sel.innerHTML='';
      options.forEach(o=>{
        const op=document.createElement('option');
        op.value=o.id; op.dataset.id=o.id; op.textContent=o.name;
        sel.appendChild(op);
      });
      sel.dataset.loaded='1';
    });
  }, e=> alert('Không tải được danh sách Khách hàng: ' + (e?.message||e)));
}

/* ========= HỢP ĐỒNG ========= */
function loadLoans(page=1){
  const q = (document.getElementById('loan_search')?.value || '').trim();
  runApi('listRecords', {tableKey:'LOANS', page, q}, res=>{
      const H=hmap(res.headers||[]);
      const idIdx     = (H['Mã HĐ'] ?? H['MaHD'] ?? 0);
      const cusIdIdx  = (H['ID Khách'] ?? H['IDVC'] ?? -1);
      const cusNameIdx= (H['Tên KH'] ?? H['TenKH'] ?? H['Tên'] ?? -1);
      const plIdx     = (H['PL KH'] ?? -1);
      const typeIdx   = (H['Hình thức'] ?? H['Loại'] ?? H['LoaiHD'] ?? -1);
      const startIdx  = (H['Ngày giải ngân'] ?? H['Bắt đầu'] ?? H['StartDate'] ?? -1);
      const monthsIdx = (H['Kỳ hạn (tháng)'] ?? H['TermMonths'] ?? -1);
      const rateIdx   = (H['Lãi suất (%/tháng)'] ?? H['Lãi/tháng'] ?? H['RatePerMonth'] ?? -1);
      const amountIdx = (H['Số tiền vay'] ?? H['Gốc'] ?? H['Principal'] ?? H['Amount'] ?? -1);
      const cycleIdx  = (H['Chu kỳ (tháng)'] ?? -1);
      const closeIdx  = (H['Ngày tất toán'] ?? H['Kết thúc'] ?? H['EndDate'] ?? -1);
      const statusIdx = (H['Trạng thái'] ?? H['Status'] ?? -1);
      const cIdx      = (H['Tạo'] ?? H['CreatedAt'] ?? -1);
      const uIdx      = (H['Cập nhật'] ?? H['UpdatedAt'] ?? -1);
      const eIdx      = (H['Người sửa'] ?? H['UpdatedBy'] ?? -1);

      const tb=document.getElementById('loan_rows'); if(!tb) return;
      tb.innerHTML='';

      const rows = res.rows || [];
      const total = res.total ?? rows.length ?? 0;
      const ttlEl = document.getElementById('loan_total');
      if (ttlEl) ttlEl.textContent='Tổng ' + total + ' bản ghi';

      rows.forEach(r=>{
        const id = pick(r,idIdx);
        const tr=document.createElement('tr');
        [
          id, pick(r,cusIdIdx), pick(r,cusNameIdx), pick(r,plIdx), pick(r,typeIdx),
          fmt(pick(r,startIdx)), pick(r,monthsIdx), pick(r,rateIdx),
          pick(r,amountIdx), pick(r,cycleIdx), fmt(pick(r,closeIdx)),
          pick(r,statusIdx), fmt(pick(r,cIdx)), fmt(pick(r,uIdx)), pick(r,eIdx)
        ].forEach(v=>{ const td=document.createElement('td'); td.textContent=(v??''); tr.appendChild(td); });

        // Thao tác
        const tdAct=document.createElement('td');
        const bView=document.createElement('button'); bView.className='btn'; bView.textContent='Xem';
        bView.onclick=()=>{ document.getElementById('slip_mahd').value=id; navigate('loanmgr'); showLoanSlip(); };
        const bEdit=document.createElement('button'); bEdit.className='btn'; bEdit.textContent='Sửa'; bEdit.style.marginLeft='6px';
        bEdit.onclick=()=> openEditLoanDialog(r, H);
        const bDel=document.createElement('button'); bDel.className='btn danger'; bDel.textContent='Xoá'; bDel.style.marginLeft='6px';
        bDel.onclick=()=> deleteLoanById(id);
        tdAct.appendChild(bView); tdAct.appendChild(bEdit); tdAct.appendChild(bDel);
        tr.appendChild(tdAct);

        tb.appendChild(tr);
      });
  }, e=> alert('Không tải được Hợp đồng: '+(e?.message||e)));
}
function openLoanDialog(){ initLoanDialog(); document.getElementById('dlg_loan').showModal(); }
function initLoanDialog(){
  ensureCustomerDropdown(true);
  const sel=document.getElementById('dlg_loan_cus_select');
  if(sel && !sel.dataset.bound){
    sel.dataset.bound='1';
    sel.addEventListener('change', ()=>{
      const op=sel.selectedOptions[0];
      document.getElementById('dlg_loan_cusid').value=op?.dataset?.id||'';
    });
  }
  // auto tính ngày tất toán
  ['dlg_loan_start','dlg_loan_months'].forEach(id=>{
    const el=document.getElementById(id);
    if(el && !el.dataset.bound){
      el.dataset.bound='1';
      el.addEventListener('input', ()=>{
        const start=(document.getElementById('dlg_loan_start')?.value||'');
        const m=(document.getElementById('dlg_loan_months')?.value||'');
        document.getElementById('dlg_loan_close').value = addMonths(start, m);
      });
    }
  });
}
function saveLoanFromDialog(){
  const cusSel  = document.getElementById('dlg_loan_cus_select');
  const cusName = cusSel?.selectedOptions?.[0]?.textContent || '';
  const cusId   = cusSel?.value || (document.getElementById('dlg_loan_cusid')?.value||'');

  const startISO = (document.getElementById('dlg_loan_start')?.value || '');
  const months   = Number((document.getElementById('dlg_loan_months')?.value || 0));
  const closeISO = (document.getElementById('dlg_loan_close')?.value || addMonths(startISO, months));
  if (document.getElementById('dlg_loan_close')) document.getElementById('dlg_loan_close').value = closeISO;

  const rec = {
    'Mã HĐ'     : (document.getElementById('dlg_loan_id')?.value || ''), 'MaHD': (document.getElementById('dlg_loan_id')?.value || ''),
    'ID Khách'  : cusId,              'IDVC': cusId,
    'Tên KH'    : cusName,            'TenKH': cusName,
    'PL KH'     : (document.getElementById('dlg_loan_plkh')?.value || ''),
    'Hình thức' : (document.getElementById('dlg_loan_type')?.value || ''),
    'Loại'      : (document.getElementById('dlg_loan_type')?.value || ''), 'LoaiHD': (document.getElementById('dlg_loan_type')?.value || ''),
    'Ngày giải ngân': startISO, 'Bắt đầu': startISO, 'StartDate': startISO,
    'Ngày tất toán' : closeISO, 'Kết thúc': closeISO, 'EndDate'  : closeISO,
    'Kỳ hạn (tháng)': months,
    'Lãi suất (%/tháng)': Number((document.getElementById('dlg_loan_rate')?.value || 0)),
    'Lãi/tháng'         : Number((document.getElementById('dlg_loan_rate')?.value || 0)), 'RatePerMonth': Number((document.getElementById('dlg_loan_rate')?.value || 0)),
    'Số tiền vay': Number((document.getElementById('dlg_loan_amount')?.value || 0)), 'Gốc': Number((document.getElementById('dlg_loan_amount')?.value || 0)), 'Principal': Number((document.getElementById('dlg_loan_amount')?.value || 0)),
    'Chu kỳ (tháng)': 1
  };

  runApi('saveRecord', {tableKey:'LOANS', record:rec}, _=>{
    const dlg=document.getElementById('dlg_loan');
    if (dlg) dlg.close();
    ['dlg_loan_id','dlg_loan_plkh','dlg_loan_cusid','dlg_loan_amount','dlg_loan_rate','dlg_loan_months','dlg_loan_start','dlg_loan_close']
      .forEach(i=>{ const el=document.getElementById(i); if(el) el.value=''; });
    if (cusSel) cusSel.value='';
    loadLoans();
    alert('Đã lưu hợp đồng');
  }, e=> alert('Lỗi lưu hợp đồng: ' + (e?.message||e)));
}
function openEditLoanDialog(row, H){
  // map row -> dialog fields
  document.getElementById('dlg_loan').showModal();
  document.getElementById('dlg_loan_id').value = pick(row, H['Mã HĐ'] ?? H['MaHD']);
  document.getElementById('dlg_loan_plkh').value = pick(row, H['PL KH']);
  // khách hàng
  ensureCustomerDropdown(true);
  const cusId = pick(row, H['ID Khách'] ?? H['IDVC']);
  document.getElementById('dlg_loan_cusid').value = cusId;
  // amount, rate, months
  document.getElementById('dlg_loan_amount').value = toNum(pick(row, H['Số tiền vay'] ?? H['Gốc'] ?? H['Principal']));
  document.getElementById('dlg_loan_rate').value   = toNum(pick(row, H['Lãi suất (%/tháng)'] ?? H['Lãi/tháng']));
  document.getElementById('dlg_loan_months').value = toNum(pick(row, H['Kỳ hạn (tháng)']));
  document.getElementById('dlg_loan_type').value   = pick(row, H['Hình thức'] ?? H['Loại']);
  const start = pick(row, H['Ngày giải ngân'] ?? H['Bắt đầu'] ?? H['StartDate']);
  const close = pick(row, H['Ngày tất toán'] ?? H['Kết thúc'] ?? H['EndDate']);
  document.getElementById('dlg_loan_start').value  = toDateInput(start);
  document.getElementById('dlg_loan_close').value  = toDateInput(close);
}
function deleteLoanById(id){
  if(!id) return;
  if(!confirm('Xoá hợp đồng '+id+' ?')) return;
  runApi('deleteRecord', {tableKey:'LOANS', id}, _=> loadLoans(), e=> alert('Không xoá được: '+(e?.message||e)));
}
function bindLoanImports(){
  const bind=(id,fn)=>{ const el=document.getElementById(id); if(el && !el.dataset.bound){ el.dataset.bound='1'; el.onclick=fn; } };
  bind('imp_loan_tpl', ()=> runApi('getImportTemplate', { tableKey:'LOANS' }, res=>{
    const link = (res && typeof res === 'object') ? (res.url || res.fileId || res.id) : res;
    alert('Đã tạo file mẫu Hợp đồng: ' + (link || '(không rõ)'));
  }));
  bind('imp_loan_run', ()=>{
    const fileId=(document.getElementById('imp_loan_file')?.value||'').trim();
    if(!fileId) return alert('Nhập Drive File ID');
    runApi('importLoansFromFile', { fileId }, res=>{
      alert('Nhập/Update hợp đồng: '+(res?.updated||0)+' dòng.');
      loadLoans();
    }, e=> alert('Lỗi import hợp đồng: '+(e?.message||e)));
  });
}

/* ========= LOAN MGR / SLIP ========= */
function bindLoanMgr(){
  const bind=(id,fn)=>{ const el=document.getElementById(id); if(el && !el.dataset.bound){ el.dataset.bound='1'; el.onclick=fn; } };
  bind('slip_btn', showLoanSlip);
  bind('slip_btn_range', showLoanSlipRange);
  bind('slip_tg_btn', sendSlipTelegram);
  bind('imp_pay_tpl', ()=> runApi('getImportTemplate', { tableKey:'PAYMENTS' }, res=>{
    const link = (res && typeof res === 'object') ? (res.url || res.fileId || res.id) : res;
    alert('Đã tạo file mẫu Thanh toán: ' + (link || '(không rõ)'));
  }));
  bind('imp_pay_run', ()=>{
    const fileId=(document.getElementById('imp_pay_file')?.value||'').trim();
    if(!fileId) return alert('Nhập Drive File ID');
    runApi('importPaymentsFromFile', { fileId }, res=>{
      alert('Nhập/Update thanh toán: '+(res?.updated||0)+' dòng.');
      loadPayHistory();
      loadUpcoming();
      showLoanSlip();
    });
  });

  // change triggers to load upcoming
  ['slip_mahd'].forEach(id=>{
    const el=document.getElementById(id);
    if(el && !el.dataset.bound){
      el.dataset.bound='1';
      el.addEventListener('change', loadUpcoming);
      el.addEventListener('blur', loadUpcoming);
    }
  });

  // payment form
  bind('pay_clear', ()=>fillPayForm({}));
  bind('pay_save', savePayment);
  bind('pay_delete', deletePayment);
}
function showLoanSlip(){
  const mahd = (document.getElementById('slip_mahd')?.value || '').trim();
  if (!mahd) return alert('Nhập Mã HĐ');
  const kSel = document.getElementById('slip_k_select');
  const forcedK = kSel && kSel.value ? Number(kSel.value) : null;

  runApi('getLoanSlip_api', { mahd, refISO: null, k: forcedK }, res=>{
    if (!res?.ok) return alert(res?.message || 'Không lấy được phiếu');
    const s = id => document.getElementById(id);
    const card = document.getElementById('slip_card'); if (card) card.style.display='block';
    if (s('slip_title')) s('slip_title').textContent  = 'Phiếu thanh toán — Kỳ ' + (res.period?.k || '-');

    s('slip_id')?.textContent   = res.loan?.id || '';
    s('slip_name')?.textContent = res.loan?.name || '';
    s('slip_type')?.textContent = res.loan?.type || '';

    s('slip_k')?.textContent        = res.period?.k || '';
    s('slip_from_txt')?.textContent = fmt(res.period?.from);
    s('slip_to_txt')?.textContent   = fmt(res.period?.to);

    s('slip_goc_due')?.textContent = money(res.period?.principalDue || 0);
    s('slip_lai_due')?.textContent = money(res.period?.interestDue  || 0);
    s('slip_goc_paid')?.textContent= money(res.paid?.principal || 0);
    s('slip_lai_paid')?.textContent= money(res.paid?.interest  || 0);

    s('slip_total_due')?.textContent    = money(res.period?.totalDue || 0);
    s('slip_total_paid')?.textContent   = money(res.paid?.total || 0);
    s('slip_total_remain')?.textContent = money(res.remaining?.total || 0);
  }, e=> alert(e?.message || e));

  loadUpcoming();
}
function showLoanSlipRange(){
  const mahd = (document.getElementById('slip_mahd')?.value || '').trim();
  if (!mahd) return alert('Nhập Mã HĐ');
  const fromISO = (document.getElementById('slip_from')?.value || '') || null;
  const toISO   = (document.getElementById('slip_to')?.value || '') || null;

  runApi('getLoanSlipRange_api', { mahd, fromISO, toISO }, res=>{
    if (!res?.ok) return alert(res?.message || 'Không lấy được phiếu');
    const s = id => document.getElementById(id);
    const card = document.getElementById('slip_card'); if (card) card.style.display='block';
    if (s('slip_title')) s('slip_title').textContent  = 'Phiếu thanh toán — Khoảng ngày';

    s('slip_id')?.textContent   = res.loan?.id || '';
    s('slip_name')?.textContent = res.loan?.name || '';
    s('slip_type')?.textContent = res.loan?.type || '';

    s('slip_k')?.textContent        = ''; // không theo kỳ cố định
    s('slip_from_txt')?.textContent = fmt(res.range?.from);
    s('slip_to_txt')?.textContent   = fmt(res.range?.to);

    s('slip_goc_due')?.textContent = money(res.due?.principal || 0);
    s('slip_lai_due')?.textContent = money(res.due?.interest  || 0);
    s('slip_goc_paid')?.textContent= money(res.paid?.principal || 0);
    s('slip_lai_paid')?.textContent= money(res.paid?.interest  || 0);

    s('slip_total_due')?.textContent    = money(res.due?.total || 0);
    s('slip_total_paid')?.textContent   = money(res.paid?.total || 0);
    s('slip_total_remain')?.textContent = money(res.remaining?.total || 0);
  }, e=> alert(e?.message || e));
}
function loadUpcoming(){
  const mahd = (document.getElementById('slip_mahd')?.value || '').trim();
  if (!mahd) return;

  runApi('getUpcomingSchedule_api', { mahd, refISO: null, count:12 }, res=>{
    const tbody = document.getElementById('upcoming_rows'); if (tbody) tbody.innerHTML='';
    const sel   = document.getElementById('slip_k_select'); if (sel) sel.innerHTML = '<option value="">(Tự động)</option>';

    (res?.rows||[]).forEach(row=>{
      const tr=document.createElement('tr');
      [row.k, fmt(row.due), money(row.goc), money(row.lai), money(row.tong)]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      tbody?.appendChild(tr);

      const op=document.createElement('option'); op.value=row.k; op.textContent='Kỳ '+row.k+' — '+fmt(row.due);
      sel?.appendChild(op);
    });

    if (sel && res?.currentK) sel.value = String(res.currentK);
  }, e=> alert(e?.message || e));
}
function loadRemindersToday(){
  const todayISO = new Date().toISOString().slice(0,10);
  runApi('getRemindersToday', { todayISO }, res=>{
    const dueT  = document.getElementById('rem_due_rows');   if (dueT)  dueT.innerHTML  = '';
    const closT = document.getElementById('rem_close_rows'); if (closT) closT.innerHTML = '';

    (res?.dueToday || []).forEach(o=>{
      const tr=document.createElement('tr');
      [o.id, o.name||'', o.k||'', fmt(o.due)]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      dueT?.appendChild(tr);
    });
    (res?.closeToday || []).forEach(o=>{
      const tr=document.createElement('tr');
      [o.id, o.name||'', fmt(o.close), o.status||'']
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      closT?.appendChild(tr);
    });
  }, e=> alert('Không tải được nhắc việc: ' + (e?.message||e)));
}

/* ========= PAYMENTS ========= */
function refreshPayTypesFromCfg(){ runApi('getAppConfig', {}, cfg=> refreshPayTypeOptions(cfg?.payTypes || ['gốc','lãi','phí'])); }
function refreshPayTypeOptions(payTypes){
  const sel = document.getElementById('pay_type'); if(!sel) return;
  sel.innerHTML='';
  (payTypes||['gốc','lãi','phí']).forEach(t=>{
    const op=document.createElement('option'); op.textContent=t; op.value=t; sel.appendChild(op);
  });
}
function fillPayForm(o){
  const g=id=>document.getElementById(id);
  if(g('pay_id')) g('pay_id').value=o.id||'';
  if(g('pay_loan')) g('pay_loan').value=o.loan||'';
  if(g('pay_date')) g('pay_date').value=toDateInput(o.date);
  if(g('pay_amount')) g('pay_amount').value=o.amount||'';
  if(g('pay_type')) g('pay_type').value=o.type||((g('pay_type')?.options?.[0]?.value)||'gốc');
  if(g('pay_note')) g('pay_note').value=o.note||'';
}
function savePayment(){
  const t=document.getElementById('pay_type')?.value || 'gốc';
  const rec={
    'PaymentID': (document.getElementById('pay_id')?.value || ''),
    'Mã HĐ'    : (document.getElementById('pay_loan')?.value || ''),
    'Ngày'     : (document.getElementById('pay_date')?.value || ''),
    'Số tiền'  : Number((document.getElementById('pay_amount')?.value || 0)),
    'Loại'     : t,
    'PTTT'     : t,
    'Ghi chú'  : (document.getElementById('pay_note')?.value || '')
  };
  runApi('saveRecord', {tableKey:'PAYMENTS', record:rec}, _=>{
    fillPayForm({}); alert('Đã lưu thanh toán'); loadUpcoming(); showLoanSlip();
  }, e=> alert('Lỗi lưu thanh toán: ' + (e?.message||e)));
}
function deletePayment(){
  const id=(document.getElementById('pay_id')?.value || '');
  if(!id) return alert('Nhập PaymentID để xoá');
  if(!confirm('Xoá thanh toán?')) return;
  runApi('deleteRecord', {tableKey:'PAYMENTS', id:id}, _=>{ fillPayForm({}); loadUpcoming(); showLoanSlip(); }, e=> alert('Không xoá được: '+(e?.message||e)));
}

/* ========= HISTORY ========= */
function loadPayHistory(){
  const mahd=(document.getElementById('hist_mahd')?.value || '').trim().toLowerCase();
  const fromISO=(document.getElementById('hist_from')?.value || '');
  const toISO=(document.getElementById('hist_to')?.value || '');
  const type=(document.getElementById('hist_type')?.value || '').toLowerCase();

  runApi('listRecords', {tableKey:'PAYMENTS', page:1, pageSize:1000}, res=>{
    const H=hmap(res.headers||[]);
    const dateIdx=H['Ngày']??-1, typeIdx=(H['Loại']??H['Loại (gốc/lãi/phí)']??H['PTTT']??-1),
          amtIdx=H['Số tiền']??-1, noteIdx=H['Ghi chú']??-1, idIdx=H['PaymentID']??0, loanIdx=H['Mã HĐ']??-1;

    const rows=(res.rows||[]).map(r=>({
      ngay: pick(r,dateIdx),
      loai: pick(r,typeIdx),
      so:   toNum(pick(r,amtIdx)),
      note: pick(r,noteIdx),
      payid:pick(r,idIdx),
      loan: (pick(r,loanIdx)||'').toString()
    })).filter(o=>{
      const loanOk = !mahd || o.loan.toLowerCase().includes(mahd);
      const typeOk = !type || String(o.loai||'').toLowerCase()===type;
      const date = o.ngay ? new Date(o.ngay) : null;
      const fromOk = !fromISO || (date && date >= new Date(fromISO));
      const toOk   = !toISO   || (date && date <= new Date(toISO + 'T23:59:59'));
      return loanOk && typeOk && fromOk && toOk;
    }).sort((a,b)=> new Date(b.ngay||0)-new Date(a.ngay||0));

    const tb=document.getElementById('hist_rows'); if (tb) tb.innerHTML='';
    let sumGoc=0,sumLai=0,sumPhi=0;
    rows.forEach(o=>{
      const tr=document.createElement('tr');
      [fmt(o.ngay), o.loan || '', (o.loai||''), money(o.so), (o.note||''), (o.payid||'')]
        .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      tb?.appendChild(tr);
      const t=String(o.loai||'').toLowerCase();
      if(t==='gốc') sumGoc+=o.so; else if(t==='lãi') sumLai+=o.so; else if(t==='phí') sumPhi+=o.so;
    });
    const info=document.getElementById('hist_info');
    if(info) info.textContent=`Tìm thấy ${rows.length} dòng` + (mahd ? ` cho Mã HĐ chứa "${mahd}"` : '');
    const sum=document.getElementById('hist_sum');
    if(sum) sum.textContent=`Tổng gốc: ${money(sumGoc)} | Tổng lãi: ${money(sumLai)} | Tổng phí: ${money(sumPhi)} | Tổng tất cả: ${money(sumGoc+sumLai+sumPhi)}`;
  }, e=> alert('Không tải được lịch sử: ' + (e?.message||e)));
}

/* ========= SETTINGS ========= */
function loadSettings(){
  runApi('getAppConfig', {}, cfg=>{
    const el = document.getElementById('cfg_fund');
    if (el) el.value = Number(cfg?.fund || 0);
    const elPT = document.getElementById('cfg_paytypes');
    if (elPT) elPT.value = (cfg?.payTypes || ['gốc','lãi','phí']).join(',');
    const chk = document.getElementById('cfg_show_kpi');
    if (chk) chk.checked = cfg?.showDashboardKpis !== false;
    refreshPayTypeOptions(cfg?.payTypes || ['gốc','lãi','phí']);
  });
}
function saveSettings(){
  const fund = Number((document.getElementById('cfg_fund')?.value || 0));
  const payTypes = (document.getElementById('cfg_paytypes')?.value || 'gốc,lãi,phí')
                   .split(',').map(s=>s.trim()).filter(Boolean);
  const showDashboardKpis = document.getElementById('cfg_show_kpi')?.checked ?? true;
  runApi('setAppConfig', { fund, payTypes, showDashboardKpis }, _=>{
    alert('Đã lưu cấu hình.');
    loadDashboard();
    refreshPayTypeOptions(payTypes);
  });
}

/* ========= ACCOUNT PREFS ========= */
function loadAccountPrefs(){
  runApi('getMyPrefs_api', {}, cfg=>{
    const t=document.getElementById('acct_timefmt'); const f=document.getElementById('acct_font');
    if(t) t.value = cfg?.timeFormat || 'vi-VN';
    if(f) f.value = cfg?.font || 'system';
  });
}
function saveAccountPrefs(){
  const timeFormat = (document.getElementById('acct_timefmt')?.value || 'vi-VN');
  const font       = (document.getElementById('acct_font')?.value || 'system');
  runApi('setMyPrefs_api', { timeFormat, font }, _=> alert('Đã lưu cài đặt hiển thị.'));
}
function changePassword(){
  const oldPw = (document.getElementById('acct_old')?.value || '');
  const newPw = (document.getElementById('acct_new')?.value || '');
  runApi('changeMyPassword_api', { oldPw, newPw }, _=>{
    alert('Đổi mật khẩu thành công.');
    document.getElementById('acct_old').value='';
    document.getElementById('acct_new').value='';
  }, e=> alert(e?.message || e));
}

/* ========= TELEGRAM ========= */
function sendSlipTelegram(){
  const mahd = (document.getElementById('slip_mahd')?.value || '').trim();
  if (!mahd) return alert('Nhập Mã HĐ trước.');
  const kSel = document.getElementById('slip_k_select');
  const k = kSel && kSel.value ? Number(kSel.value) : null;

  runApi('sendSlipToTelegram', { mahd, refISO: null, k }, res=>{
    const note = res?.url ? (' — ' + res.url) : (res?.message ? (' — ' + res.message) : (res?.k ? (' — Kỳ ' + res.k) : ''));
    alert('Đã gửi phiếu vào Telegram' + (note || ''));
  }, e=> alert('Lỗi gửi Telegram: ' + (e?.message || e)));
}

/* ========= READY ========= */
window.addEventListener('hashchange', onRoute);
window.addEventListener('DOMContentLoaded', ()=>{
  setAuthState(false);
  renderMenu();
  applyMenuVisibility();
  if(!location.hash) navigate('dashboard');
  onRoute();

  const bind=(id,fn)=>{ const el=document.getElementById(id); if(el && !el.dataset.bound){ el.dataset.bound='1'; el.onclick=fn; } };

  // KH
  bind('cus_btnSearch', ()=>loadCustomers());
  bind('btn_new_customer', ()=>document.getElementById('dlg_customer').showModal());
  bind('dlg_cus_save', saveCustomerFromDialog);

  // HĐ
  bind('loan_btnSearch', ()=>loadLoans());
  bind('btn_new_loan', openLoanDialog);
  bind('dlg_loan_save', saveLoanFromDialog);

  // History
  bind('hist_load', loadPayHistory);

  // Settings
  bind('cfg_save', saveSettings);

  // Account
  bind('acct_saveprefs', saveAccountPrefs);
  bind('acct_chpass',    changePassword);
});

// ===== Session token (tài khoản nội bộ) =====
const SESS_KEY = 'WQT_SESSION';
const getToken = () => localStorage.getItem(SESS_KEY) || '';
const setToken = (t) => t ? localStorage.setItem(SESS_KEY, t) : localStorage.removeItem(SESS_KEY);
const withSession = (payload={}) => {
  const out = Object.assign({}, payload || {});
  const t = getToken();
  if (t) out.session = t;
  return out;
};

function runApi(fn, payload, onOk, onFail){
  const req = withSession(payload);
  const ok = (typeof onOk === 'function') ? onOk : (()=>{});
  const fail = (typeof onFail === 'function') ? onFail : (err=> alert(err?.message || err));
  google.script.run
    .withSuccessHandler(ok)
    .withFailureHandler(err=>{
      const msg = err?.message || err;
      const lower = String(msg||'').toLowerCase();
      if (lower.includes('chưa đăng nhập') || lower.includes('cần đăng nhập')){
        setToken('');
        setAuthState(false);
        showLoginDialog();
        return;
      }
      fail(err);
    })
    [fn](req);
}

// Đăng nhập
function openLogin(){ showLoginDialog(); }

function handleLoginSuccess(res, fallbackUser){
  if (!res?.ok || !res.token) return false;
  setToken(res.token);
  setAuthState(true, res);
  closeLoginDialog();
  applyMenuVisibility();
  onRoute();
  const name = res.display || fallbackUser || '';
  if (name) alert('Xin chào ' + name);
  return true;
}

function doLogin(){
  const u = (document.getElementById('login_user')?.value || '').trim();
  const p = (document.getElementById('login_pass')?.value || '');
  runApi('local_login_api', { user: u, password: p }, res=>{
    if (!handleLoginSuccess(res, u)) return alert('Đăng nhập thất bại.');
  }, e=> alert(e?.message||e));
}

// Bật modal nếu chưa có phiên
function ensureLogin() {
  runApi('whoami', {}, (res)=>{
    if (res && res.ok) {
      setAuthState(true, res);
      applyMenuVisibility();
      onRoute();
    } else {
      setAuthState(false);
      showLoginDialog();
    }
  }, ()=>{ setAuthState(false); showLoginDialog(); });
}

function bindLoginButton(){
  const btn = document.getElementById('btn_login_do');
  if (!btn || btn.dataset.bound) return;
  btn.dataset.bound = '1';
  btn.addEventListener('click', ()=>{
    const u = (document.getElementById('login_user')?.value || '').trim();
    const p = (document.getElementById('login_pass')?.value || '');
    if (!u || !p) return alert('Nhập tài khoản và mật khẩu.');
    runApi('local_login_api', { user:u, password:p }, res=>{
      if (!handleLoginSuccess(res, u)) alert('Đăng nhập thất bại.');
    }, e=> alert(e?.message || e));
  });
}

// Đăng xuất
function logoutAll(){
  const t = getToken();
  runApi('local_logout_api', { token: t }, _=>{
    setToken('');
    setAuthState(false);
    showLoginDialog();
    onRoute();
  }, ()=>{
    setToken('');
    setAuthState(false);
    showLoginDialog();
    onRoute();
  });
}

window.addEventListener('DOMContentLoaded', ()=>{
  setAuthState(false);
  bindLoginButton();
  ensureLogin();
  const dlg = document.getElementById('dlg_login');
  if (dlg && !dlg.dataset.guardBound){
    dlg.dataset.guardBound='1';
    dlg.addEventListener('cancel', ev=>{
      if (!AUTH_STATE.ok){ ev.preventDefault(); showLoginDialog(); }
    });
  }
});
</script>