<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Web Admin (Quản lý SCHEMA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --pad: 12px;
      --radius: 12px;
      --indigo: #4f46e5;
      --bg: #f6f7fb;
      --muted: #6b7280;
      --sidebar: #111827;
      --sidebar-text: #f8fafc;
      --card-border: #e5e7eb;
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #0f172a;
      min-height: 100vh;
    }
    .hidden { display: none !important; }
    .muted { color: var(--muted); }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .topbar .brand {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .topbar .spacer { flex: 1; }
    .auth-status { font-size: 14px; }

    .btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #111827;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.2s ease;
    }
    .btn.primary {
      background: var(--indigo);
      border-color: var(--indigo);
    }
    .btn.danger {
      background: #ef4444;
      border-color: #ef4444;
    }
    .btn.ghost {
      background: #fff;
      border-color: #d1d5db;
      color: #111827;
    }
    .btn:hover {
      opacity: 0.95;
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
    }

    .layout {
      display: flex;
      min-height: calc(100vh - 72px);
    }
    .sidebar {
      width: 240px;
      background: var(--sidebar);
      color: var(--sidebar-text);
      padding: 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .sidebar h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .menu-vertical {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .tabbtn {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      background: rgba(248, 250, 252, 0.08);
      color: inherit;
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      transition: background 0.18s ease, transform 0.12s ease;
    }
    .tabbtn:hover { transform: translateX(2px); background: rgba(248, 250, 252, 0.18); }
    .tabbtn.active { background: #fff; color: var(--sidebar); }

    .content {
      flex: 1;
      padding: 24px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .content section { display: flex; flex-direction: column; gap: 18px; }

    .card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 220px; }
    label { display: block; font-size: 12px; color: #475569; margin: 4px 0 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--indigo);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
      outline: none;
    }
    input[readonly] { background: #f3f4f6; color: #6b7280; }
    .chk { display: flex; align-items: center; gap: 8px; margin-top: 26px; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eef2f7; white-space: nowrap; text-align: left; }
    thead th { background: #fafafa; position: sticky; top: 0; z-index: 1; }
    tr:hover { background: #fafafa; }

    .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      font-weight: 600;
      margin: 2px;
    }
    .table-btn {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #111;
      cursor: pointer;
    }
    .table-btn.danger { border-color: #ef4444; color: #b91c1c; }
    .table-btn.primary { border-color: var(--indigo); color: var(--indigo); }
    .table-btn:hover { box-shadow: none; transform: none; opacity: 1; background: #f9fafb; }

    .menu-grid { display: flex; flex-wrap: wrap; gap: 10px 16px; margin: 10px 0 6px; }
    .menu-grid label { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #1f2937; }
    .menu-grid input { width: auto; }

    .view.hidden { display: none; }

    .login-blocker {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(246, 247, 251, 0.94);
      backdrop-filter: blur(2px);
      z-index: 5;
      padding: 24px;
    }
    .login-blocker.hidden { display: none; }
    .login-blocker-card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 420px;
      width: 100%;
      text-align: left;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .login-blocker-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .login-form { display: flex; flex-direction: column; gap: 12px; }
    .login-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .login-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 4px;
    }
    .login-actions .btn { min-width: 140px; }

    dialog.modal,
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      border: none;
      background: transparent;
    }
    dialog.modal[open],
    .modal-overlay.show { display: flex; }
    dialog.modal::backdrop { background: rgba(17, 24, 39, 0.35); }
    .modal-overlay::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(17, 24, 39, 0.35);
    }
    dialog.modal .box,
    .modal-overlay .box {
      position: relative;
      width: min(420px, 96vw);
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--card-border);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal .head { display: flex; align-items: center; gap: 12px; }
    .modal .title { font-weight: 700; font-size: 16px; }
    .modal .body { display: flex; flex-direction: column; gap: 12px; }
    .modal .field { text-align: left; }
    .modal .foot { display: flex; gap: 8px; justify-content: flex-end; }

    @media (max-width: 960px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
      .menu-vertical { flex-direction: row; width: 100%; }
      .tabbtn { flex: 1; text-align: center; }
    }
  </style>
</head>
<body class="needs-login">
  <header class="topbar">
    <div class="brand">Quản trị cấu hình</div>
    <div class="spacer"></div>
    <div id="auth_status" class="auth-status muted">Chưa đăng nhập</div>
    <button id="btn_open_login" class="btn" type="button">Đăng nhập</button>
    <button id="btn_logout" class="btn danger hidden" type="button">Đăng xuất</button>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <h2>Danh mục</h2>
      <nav class="menu-vertical" id="admin_menu">
        <button class="tabbtn active" data-tab="schema" type="button">Quản lý schema</button>
        <button class="tabbtn" data-tab="accounts" type="button">Quản lý tài khoản</button>
      </nav>
    </aside>
    <main class="content">
      <div id="login_blocker" class="login-blocker">
        <div class="login-blocker-card">
          <div>
            <div class="login-blocker-title">Vui lòng đăng nhập</div>
            <p class="muted" style="margin:0">Sử dụng tài khoản nội bộ để quản lý schema và tài khoản sử dụng Web Quản Trị.</p>
          </div>
          <div class="login-form">
            <div class="login-field">
              <label for="login_user">Tài khoản</label>
              <input id="login_user" class="input" type="text" autocomplete="username" />
            </div>
            <div class="login-field">
              <label for="login_pass">Mật khẩu</label>
              <input id="login_pass" class="input" type="password" autocomplete="current-password" />
            </div>
            <div class="login-actions">
              <button class="btn primary" type="button" id="btn_login_do">Đăng nhập</button>
            </div>
            <div class="muted" style="font-size:12px">Bạn cũng có thể đăng nhập Google (nếu email của bạn nằm trong danh sách cho phép).</div>
          </div>
        </div>
      </div>

      <section id="view-schema" class="view">
        <div class="card">
          <h2 style="margin-top:4px">Thiết lập schema dữ liệu</h2>
          <div class="row">
            <div class="col">
              <label>Bảng</label>
              <select id="tbl"></select>
              <div class="muted" id="tblNote" style="margin-top:6px"></div>
            </div>
            <div class="col">
              <label>Trường (Field)</label>
              <input id="field" placeholder="Ví dụ: Address" />
            </div>
            <div class="col">
              <label>Nhãn hiển thị (Label)</label>
              <input id="label" placeholder="Ví dụ: Địa chỉ" />
            </div>
            <div class="col">
              <label>Kiểu dữ liệu (Type)</label>
              <select id="type">
                <option value="string">Chuỗi ký tự</option>
                <option value="number">Số</option>
                <option value="date">Ngày</option>
                <option value="enum">Lựa chọn (enum)</option>
              </select>
            </div>
            <div class="col">
              <label>Giá trị lựa chọn (Enum, cách nhau dấu phẩy)</label>
              <input id="enum" placeholder="VND,USD,LAK" />
            </div>
            <div class="col">
              <label>Mặc định (Default)</label>
              <input id="def" placeholder="" />
            </div>
            <div class="col chk">
              <input id="req" type="checkbox" />
              <label for="req" style="margin:0">Bắt buộc</label>
            </div>
            <div class="col" style="flex:0 0 180px">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnAdd" type="button">+ Thêm cột</button>
            </div>
          </div>
          <div class="muted" id="msg" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Danh sách cột</h3>
            <button id="btnApply" class="btn primary" type="button">Áp dụng Schema → Sheet</button>
          </div>
          <div style="overflow:auto; max-height:60vh">
            <table>
              <thead>
                <tr>
                  <th>Thứ tự</th>
                  <th>Trường</th>
                  <th>Nhãn</th>
                  <th>Kiểu</th>
                  <th>Bắt buộc</th>
                  <th>Enum</th>
                  <th>Mặc định</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="view-accounts" class="view hidden">
        <div class="card" id="cardAccounts">
          <h2 style="margin-top:0">Quản lý tài khoản đăng nhập WQT</h2>
          <div class="row">
            <div class="col">
              <label>Tài khoản</label>
              <input id="acc_user" placeholder="Ví dụ: admin" />
            </div>
            <div class="col">
              <label>Tên hiển thị</label>
              <input id="acc_display" placeholder="Tên nhân viên" />
            </div>
            <div class="col">
              <label>Mật khẩu mới</label>
              <input id="acc_password" type="password" placeholder="Để trống nếu giữ nguyên" />
            </div>
            <div class="col chk" style="min-width:140px">
              <input id="acc_active" type="checkbox" checked />
              <label for="acc_active" style="margin:0">Kích hoạt</label>
            </div>
          </div>

          <div class="col" style="padding:0">
            <label>Quyền menu (chọn những mục được phép sử dụng)</label>
            <div id="acc_menus" class="menu-grid"></div>
            <div class="muted">Bỏ chọn mục để ẩn khỏi giao diện Web Quản Trị.</div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnAccSave" type="button">Lưu tài khoản</button>
            <button class="btn ghost" id="btnAccNew" type="button">Làm mới form</button>
          </div>
          <div class="muted" id="acc_msg" style="margin-top:6px"></div>

          <div style="overflow:auto; max-height:50vh; margin-top:16px">
            <table>
              <thead>
                <tr>
                  <th>Tài khoản</th>
                  <th>Tên hiển thị</th>
                  <th>Quyền menu</th>
                  <th>Trạng thái</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="acc_rows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    window.onerror = (m) => alert('Lỗi JS: ' + m);

    const CSRF   = '<?= (typeof csrf  !== "undefined" && csrf)  ? csrf  : "" ?>';
    const UI_CFG = <?!= JSON.stringify((typeof uiCfg !== "undefined" && uiCfg) ? uiCfg : { pageSize:20 }) ?>;

    const MENU_TABS = ['schema', 'accounts'];
    let currentTab = 'schema';

    let SCHEMA = null;
    let current = 'CUSTOMERS';
    const MENU_LABELS = {
      dashboard: 'Tổng quan',
      customers: 'Khách hàng',
      loans: 'Hợp đồng',
      loanmgr: 'Quản lý khoản vay/Thanh toán',
      payhistory: 'Lịch sử thanh toán',
      crm: 'CRM',
      telegram: 'Nhóm Telegram',
      reports: 'Báo cáo',
      settings: 'Cấu hình',
      account: 'Cài đặt',
      schema: 'Quản lý schema'
    };
    let ACCOUNT_MENUS = [];
    let ACCOUNTS = [];
    let selectedAccount = null;

    const AUTH_STATE = { ok: false, principal: '', info: {}, mode: '' };

    document.addEventListener('DOMContentLoaded', () => {
      bindMenu();
      bindButtons();
      bindLoginUI();
      setAuthState(false);
      ensureLogin();
    });

    function bindMenu(){
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.tab;
          if (!key || key === currentTab) return;
          currentTab = key;
          updateTabs();
        });
      });
      updateTabs();
    }

    function updateTabs(){
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === currentTab);
      });
      document.querySelectorAll('.view').forEach(view => {
        const viewKey = view.id.replace('view-', '');
        view.classList.toggle('hidden', viewKey !== currentTab);
      });
      if (AUTH_STATE.ok) {
        loadActiveTab();
      }
    }

    function bindButtons(){
      const btnAdd = document.getElementById('btnAdd');
      if (btnAdd) btnAdd.addEventListener('click', addField);
      const btnApply = document.getElementById('btnApply');
      if (btnApply) btnApply.addEventListener('click', applySchema);
      const saveBtn = document.getElementById('btnAccSave');
      if (saveBtn) saveBtn.addEventListener('click', saveAccount);
      const newBtn = document.getElementById('btnAccNew');
      if (newBtn) newBtn.addEventListener('click', () => {
        clearAccountForm();
        const msg = document.getElementById('acc_msg');
        if (msg) msg.textContent = '';
      });
    }

    function bindLoginUI(){
      const btnLogin = document.getElementById('btn_open_login');
      if (btnLogin) btnLogin.addEventListener('click', openLogin);
      const btnLogout = document.getElementById('btn_logout');
      if (btnLogout) btnLogout.addEventListener('click', logoutAll);
      const loginBtn = document.getElementById('btn_login_do');
      if (loginBtn && !loginBtn.dataset.bound){
        loginBtn.dataset.bound = '1';
        loginBtn.addEventListener('click', doLogin);
      }
      const userInput = document.getElementById('login_user');
      const passInput = document.getElementById('login_pass');
      [userInput, passInput].forEach(input => {
        if (!input) return;
        input.addEventListener('keydown', ev => {
          if (ev.key === 'Enter') { ev.preventDefault(); doLogin(); }
        });
      });
      const dlg = document.getElementById('dlg_login');
      if (dlg && !dlg.dataset.guardBound){
        dlg.dataset.guardBound = '1';
        dlg.addEventListener('cancel', ev => {
          if (!AUTH_STATE.ok){ ev.preventDefault(); showLoginDialog(); }
        });
      }
    }

    function setAuthState(ok, meta){
      const prev = { ok: AUTH_STATE.ok, principal: AUTH_STATE.principal, mode: AUTH_STATE.mode };
      AUTH_STATE.ok = !!ok;
      AUTH_STATE.info = ok ? (meta || {}) : {};
      AUTH_STATE.principal = ok ? (meta?.display || meta?.principal || '') : '';
      AUTH_STATE.mode = ok ? (meta?.mode || (meta?.menus ? 'local' : '')) : '';

      const status = document.getElementById('auth_status');
      if (status){
        status.textContent = ok ? ('Đã đăng nhập' + (AUTH_STATE.principal ? ': ' + AUTH_STATE.principal : '')) : 'Chưa đăng nhập';
        status.classList.toggle('muted', !ok);
      }
      const loginBtn = document.getElementById('btn_open_login');
      if (loginBtn) loginBtn.classList.toggle('hidden', ok);
      const logoutBtn = document.getElementById('btn_logout');
      if (logoutBtn) logoutBtn.classList.toggle('hidden', !ok);
      const blocker = document.getElementById('login_blocker');
      if (blocker) blocker.classList.toggle('hidden', ok);
      document.body.classList.toggle('needs-login', !ok);

      if (ok) {
        closeLoginDialog();
        loadActiveTab();
      } else {
        resetSchemaUI();
        resetAccountUI();
      }

      const changed = prev.ok !== AUTH_STATE.ok || prev.principal !== AUTH_STATE.principal || prev.mode !== AUTH_STATE.mode;
      if (changed){
        window.dispatchEvent(new CustomEvent(AUTH_EVENT_NAME, {
          detail: {
            ok: AUTH_STATE.ok,
            mode: AUTH_STATE.mode,
            principal: AUTH_STATE.principal
          }
        }));
      }
    }

    function resetSchemaUI(){
      SCHEMA = null;
      const sel = document.getElementById('tbl'); if (sel) sel.innerHTML = '';
      const note = document.getElementById('tblNote'); if (note) note.textContent = '';
      const tb = document.getElementById('tbody'); if (tb) tb.innerHTML = '';
      document.getElementById('msg')?.textContent = '';
    }

    function resetAccountUI(){
      ACCOUNT_MENUS = [];
      ACCOUNTS = [];
      selectedAccount = null;
      clearAccountForm();
      const rows = document.getElementById('acc_rows'); if (rows) rows.innerHTML = '';
      renderMenuChoices([]);
      const msg = document.getElementById('acc_msg'); if (msg) msg.textContent = '';
    }

    function loadActiveTab(){
      if (currentTab === 'accounts') loadAccounts();
      else loadSchema();
    }

    function loadSchema(){
      runApi('api_schema_list', {}, defs => {
        SCHEMA = defs || {};
        const sel = document.getElementById('tbl');
        if (!sel) return;
        sel.innerHTML = '';
        const keys = Object.keys(SCHEMA);
        keys.forEach(k => {
          const opt = document.createElement('option');
          const sheetName = SCHEMA[k]?.sheetName || '';
          opt.value = k;
          opt.textContent = sheetName ? `${k} (${sheetName})` : k;
          sel.appendChild(opt);
        });
        if (!SCHEMA[current]) current = keys[0] || '';
        if (current) sel.value = current;
        sel.onchange = () => { current = sel.value; renderSchemaTable(); };
        renderSchemaTable();
      }, showErr);
    }

    function renderSchemaTable(){
      const tb = document.getElementById('tbody');
      if (!tb) return;
      tb.innerHTML = '';
      if (!SCHEMA || !current || !SCHEMA[current]){
        document.getElementById('tblNote')?.textContent = '';
        return;
      }
      const def = SCHEMA[current];
      document.getElementById('tblNote').textContent = `Bảng ${current} có ${def.cols.length} cột. Sheet đích: ${def.sheetName}`;

      (def.cols || []).forEach((f, idx) => {
        const tr = document.createElement('tr');
        const label = def.labels?.[f] || '';
        tr.innerHTML = `<td>${idx + 1}</td><td>${f}</td><td>${label}</td><td></td><td></td><td></td><td></td>`;
        const tdAct = document.createElement('td');
        if (f !== def.idCol){
          const btn = document.createElement('button');
          btn.className = 'table-btn danger';
          btn.textContent = 'Xoá';
          btn.addEventListener('click', () => deleteField(f));
          tdAct.appendChild(btn);
        }
        tr.appendChild(tdAct);
        tb.appendChild(tr);
      });

      document.getElementById('msg').textContent = '';
      document.getElementById('field').value = '';
      document.getElementById('label').value = '';
      document.getElementById('type').value = 'string';
      document.getElementById('enum').value = '';
      document.getElementById('def').value = '';
      document.getElementById('req').checked = false;
    }

    function deleteField(field){
      if (!field) return;
      if (!confirm('Xoá cột "' + field + '" khỏi schema?')) return;
      runApi('api_schema_delete', { table: current, field }, () => loadSchema(), showErr);
    }

    function addField(){
      if (!SCHEMA || !current){ alert('Chưa có schema để thêm cột.'); return; }
      const field = document.getElementById('field').value.trim();
      const label = document.getElementById('label').value.trim() || field;
      const type = document.getElementById('type').value;
      const ev = document.getElementById('enum').value.trim();
      const defv = document.getElementById('def').value.trim();
      const req = document.getElementById('req').checked;
      if (!field){ alert('Vui lòng nhập tên Trường (Field).'); return; }
      if (SCHEMA[current].cols.includes(field)){ alert('Cột đã tồn tại trong schema.'); return; }

      runApi('api_schema_add', {
        table: current,
        field,
        label,
        type,
        required: req,
        enumValues: ev,
        defaultValue: defv
      }, () => {
        document.getElementById('msg').textContent = 'Đã thêm cột "' + field + '". Nhấn "Áp dụng Schema" để đồng bộ sang sheet.';
        loadSchema();
      }, showErr);
    }

    function applySchema(){
      runApi('api_schema_apply', { table: current }, () => {
        alert('Đã áp dụng Schema sang các sheet dữ liệu.');
        loadSchema();
      }, showErr);
    }

    function loadAccounts(){
      runApi('admin_listLocalUsers', {}, res => {
        ACCOUNT_MENUS = res?.allMenus || [];
        ACCOUNTS = res?.rows || [];
        const selected = selectedAccount && ACCOUNTS.find(a => String(a.user).toLowerCase() === String(selectedAccount).toLowerCase());
        if (!selected) selectedAccount = null;
        renderMenuChoices(selected?.menus || []);
        renderAccountRows();
        if (selectedAccount && !selected){
          const msg = document.getElementById('acc_msg');
          if (msg) msg.textContent = 'Tài khoản đã bị xoá.';
          clearAccountForm();
        }
      }, showErr);
    }

    function renderMenuChoices(selectedMenus){
      const wrap = document.getElementById('acc_menus');
      if (!wrap) return;
      wrap.innerHTML = '';
      if (!ACCOUNT_MENUS.length){
        const span = document.createElement('span');
        span.className = 'muted';
        span.textContent = 'Chưa có cấu hình MENU_CONFIG.';
        wrap.appendChild(span);
        return;
      }
      const selectedSet = new Set((selectedMenus || []).map(m => String(m)));
      ACCOUNT_MENUS.forEach(key => {
        const id = 'acc_menu_' + key;
        const label = document.createElement('label');
        label.setAttribute('for', id);
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.value = key;
        if (selectedSet.has(key)) input.checked = true;
        const span = document.createElement('span');
        span.textContent = MENU_LABELS[key] || key;
        label.appendChild(input);
        label.appendChild(span);
        wrap.appendChild(label);
      });
    }

    function renderAccountRows(){
      const tbody = document.getElementById('acc_rows');
      if (!tbody) return;
      tbody.innerHTML = '';
      ACCOUNTS.forEach(acc => {
        const tr = document.createElement('tr');
        const tdUser = document.createElement('td'); tdUser.textContent = acc.user || '';
        const tdDisp = document.createElement('td'); tdDisp.textContent = acc.display || acc.user || '';
        const tdMenus = document.createElement('td');
        if (acc.menus && acc.menus.length){
          acc.menus.forEach(m => {
            const chip = document.createElement('span');
            chip.className = 'badge';
            chip.textContent = MENU_LABELS[m] || m;
            tdMenus.appendChild(chip);
          });
        } else {
          tdMenus.innerHTML = '<span class="muted">Không có</span>';
        }
        const tdActive = document.createElement('td');
        tdActive.textContent = acc.active ? 'Đang hoạt động' : 'Đã khoá';
        const tdAct = document.createElement('td');
        tdAct.style.whiteSpace = 'nowrap';
        const btnSel = document.createElement('button');
        btnSel.className = 'table-btn primary';
        btnSel.textContent = 'Chọn';
        btnSel.addEventListener('click', () => selectAccount(acc.user));
        const btnDel = document.createElement('button');
        btnDel.className = 'table-btn danger';
        btnDel.textContent = 'Xoá';
        btnDel.addEventListener('click', () => deleteAccount(acc.user));
        tdAct.appendChild(btnSel);
        tdAct.appendChild(btnDel);
        tr.appendChild(tdUser);
        tr.appendChild(tdDisp);
        tr.appendChild(tdMenus);
        tr.appendChild(tdActive);
        tr.appendChild(tdAct);
        if (selectedAccount && acc.user && String(acc.user).toLowerCase() === String(selectedAccount).toLowerCase()){
          tr.style.background = '#eef2ff';
        }
        tbody.appendChild(tr);
      });
    }

    function collectSelectedMenus(){
      const wrap = document.getElementById('acc_menus');
      if (!wrap) return [];
      return Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked')).map(el => el.value);
    }

    function selectAccount(user){
      const acc = ACCOUNTS.find(a => String(a.user).toLowerCase() === String(user).toLowerCase());
      if (!acc) return;
      selectedAccount = acc.user;
      const inputUser = document.getElementById('acc_user');
      if (inputUser){ inputUser.value = acc.user || ''; inputUser.readOnly = true; }
      const inputDisplay = document.getElementById('acc_display');
      if (inputDisplay) inputDisplay.value = acc.display || acc.user || '';
      const pw = document.getElementById('acc_password'); if (pw) pw.value = '';
      const active = document.getElementById('acc_active'); if (active) active.checked = !!acc.active;
      renderMenuChoices(acc.menus || []);
      const msg = document.getElementById('acc_msg');
      if (msg) msg.textContent = 'Đang chỉnh sửa tài khoản "' + (acc.user || '') + '".';
      renderAccountRows();
    }

    function clearAccountForm(){
      selectedAccount = null;
      const inputUser = document.getElementById('acc_user');
      if (inputUser){ inputUser.value = ''; inputUser.readOnly = false; }
      const inputDisplay = document.getElementById('acc_display'); if (inputDisplay) inputDisplay.value = '';
      const pw = document.getElementById('acc_password'); if (pw) pw.value = '';
      const active = document.getElementById('acc_active'); if (active) active.checked = true;
      renderMenuChoices([]);
      renderAccountRows();
    }

    function saveAccount(){
      const inputUser = document.getElementById('acc_user');
      const user = (inputUser?.value || '').trim();
      if (!user){ alert('Nhập tài khoản.'); return; }
      const display = (document.getElementById('acc_display')?.value || '').trim() || user;
      const password = document.getElementById('acc_password')?.value || '';
      const active = document.getElementById('acc_active')?.checked !== false;
      const menus = collectSelectedMenus();
      if (!menus.length && !confirm('Tài khoản không có quyền menu nào. Bạn chắc chắn muốn lưu?')) return;
      const payload = { user, display, active, menus };
      if (password) payload.password = password;
      runApi('admin_upsertLocalUser', payload, res => {
        const msg = document.getElementById('acc_msg');
        if (msg) msg.textContent = 'Đã lưu tài khoản "' + user + '".';
        if (!password){
          const pw = document.getElementById('acc_password');
          if (pw) pw.value = '';
        }
        if (!selectedAccount || String(selectedAccount).toLowerCase() !== user.toLowerCase()){
          clearAccountForm();
        }
        selectedAccount = user;
        loadAccounts();
      }, showErr);
    }

    function deleteAccount(user){
      if (!user) return;
      if (!confirm('Xoá tài khoản "' + user + '"?')) return;
      runApi('admin_deleteLocalUser', { user }, () => {
        if (selectedAccount && String(selectedAccount).toLowerCase() === String(user).toLowerCase()){
          clearAccountForm();
          const msg = document.getElementById('acc_msg');
          if (msg) msg.textContent = 'Đã xoá tài khoản "' + user + '".';
        }
        loadAccounts();
      }, showErr);
    }

    const SESSION_STORAGE_KEY = 'WQT_ADMIN_TOKEN';
    const SESSION_EVENT_NAME = 'wqt:session-change';
    const AUTH_EVENT_NAME = 'wqt:auth-change';
    const getToken = () => localStorage.getItem(SESSION_STORAGE_KEY) || '';
    const setToken = (t) => {
      const token = t ? String(t) : '';
      if (token){
        localStorage.setItem(SESSION_STORAGE_KEY, token);
      } else {
        localStorage.removeItem(SESSION_STORAGE_KEY);
      }
      window.dispatchEvent(new CustomEvent(SESSION_EVENT_NAME, { detail: { token } }));
    };
    const withSession = (payload = {}) => {
      const out = Object.assign({}, payload || {});
      const t = getToken();
      if (t) out.session = t;
      return out;
    };

    function runApi(fn, payload, onOk, onFail){
      const req = withSession(payload);
      const ok = (typeof onOk === 'function') ? onOk : (() => {});
      const fail = (typeof onFail === 'function') ? onFail : (err => alert(err?.message || err));
      if (typeof google === 'undefined' || !google.script || !google.script.run){
        console.warn('Google Apps Script runtime không sẵn sàng.');
        fail({ message: 'Không thể kết nối tới Apps Script.' });
        return;
      }
      const runner = google.script.run
        .withSuccessHandler(ok)
        .withFailureHandler(err => {
          const msg = err?.message || err;
          const lower = String(msg || '').toLowerCase();
          if (lower.includes('chưa đăng nhập') || lower.includes('cần đăng nhập')){
            setToken('');
            setAuthState(false);
            showLoginDialog();
            return;
          }
          fail(err);
        });
      runner[fn](req);
    }

    function openLogin(){ showLoginDialog(); }

    function showLoginDialog(){
      const blocker = document.getElementById('login_blocker');
      if (blocker) blocker.classList.remove('hidden');
      const dlg = document.getElementById('dlg_login');
      if (dlg){
        if (dlg.classList?.contains('modal-overlay')){
          dlg.classList.add('show');
        } else if (typeof dlg.showModal === 'function'){
          if (!dlg.open) dlg.showModal();
        } else {
          dlg.setAttribute('open', 'true');
          dlg.classList.add('show');
        }
      }
      const user = document.getElementById('login_user');
      if (user){
        setTimeout(() => { user.focus(); user.select(); }, 0);
      }
    }

    function closeLoginDialog(){
      const dlg = document.getElementById('dlg_login');
      if (dlg){
        if (dlg.classList?.contains('modal-overlay')){
          dlg.classList.remove('show');
        } else if (typeof dlg.close === 'function'){
          dlg.close();
        } else {
          dlg.removeAttribute('open');
          dlg.classList.remove('show');
        }
      }
    }

    function handleLoginSuccess(res, fallbackUser){
      if (!res?.ok || !res.token) return false;
      setToken(res.token);
      setAuthState(true, res);
      const name = res.display || fallbackUser || '';
      if (name) alert('Xin chào ' + name);
      return true;
    }

    function doLogin(){
      const u = (document.getElementById('login_user')?.value || '').trim();
      const p = document.getElementById('login_pass')?.value || '';
      if (!u || !p) return alert('Nhập tài khoản và mật khẩu.');
      runApi('config_local_login_api', { user: u, password: p }, res => {
        if (!handleLoginSuccess(res, u)) alert('Đăng nhập thất bại.');
      }, e => alert(e?.message || e));
    }

    function ensureLogin(){
      runApi('whoami', {}, res => {
        if (res && res.ok) {
          setAuthState(true, res);
        } else {
          setAuthState(false);
          showLoginDialog();
        }
      }, () => {
        setAuthState(false);
        showLoginDialog();
      });
    }

    function logoutAll(){
      const t = getToken();
      runApi('config_local_logout_api', { token: t }, () => {
        setToken('');
        setAuthState(false);
        showLoginDialog();
      }, () => {
        setToken('');
        setAuthState(false);
        showLoginDialog();
      });
    }

    function showErr(e){
      const msg = e && e.message ? e.message : e;
      alert('Lỗi: ' + msg);
    }
  </script>
</body>
</html>
