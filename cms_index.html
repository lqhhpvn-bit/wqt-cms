<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Web Quản Trị</title>
    <?!= include('cms_styles'); ?>
  </head>
  <body class="needs-login">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="brand">Web Quản Trị</div>
      <div class="spacer"></div>
      <div id="auth_status" class="auth-status muted">Chưa đăng nhập</div>
      <button id="btn_open_login" class="btn" onclick="openLogin()">Đăng nhập</button>
      <button id="btn_logout" class="btn danger hidden" onclick="logoutAll()">Đăng xuất</button>
    </header>

    <!-- ========== LAYOUT VỚI SIDEBAR TRÁI ========== -->
    <div class="app">
      <div id="login_blocker" class="login-blocker">
        <div class="login-blocker-card">
          <div class="login-blocker-title">Vui lòng đăng nhập</div>
          <p>Đăng nhập để xem và thao tác dữ liệu quản trị. Liên hệ quản trị viên nếu bạn chưa có tài khoản.</p>
          <button class="btn primary" onclick="openLogin()">Đăng nhập ngay</button>
        </div>
      </div>

      <aside class="sidebar">
        <div class="sidebar-head">
          <div class="meta">
            <div class="name">Web Quản Trị</div>
          </div>
        </div>

        <!-- NAV: GIỮ id="menu" (JS cũ có thể gắn sự kiện vào đây) -->
        <nav id="menu" class="menu-vertical">
          <!-- Fallback menu (được JS thay thế khi tải xong) -->
          <button class="tabbtn active" data-key="dashboard" onclick="navigate('dashboard')">Tổng quan</button>
          <button class="tabbtn" data-key="customers" onclick="navigate('customers')">Khách hàng</button>
          <button class="tabbtn" data-key="loans" onclick="navigate('loans')">Hợp đồng</button>
          <button class="tabbtn" data-key="loanmgr" onclick="navigate('loanmgr')">Quản lý khoản vay/Thanh toán</button>
          <button class="tabbtn" data-key="payhistory" onclick="navigate('payhistory')">Lịch sử thanh toán</button>
          <button class="tabbtn" data-key="crm" onclick="navigate('crm')">CRM</button>
          <button class="tabbtn" data-key="telegram" onclick="navigate('telegram')">Nhóm Telegram</button>
          <button class="tabbtn" data-key="reports" onclick="navigate('reports')">Báo cáo</button>
          <button class="tabbtn" data-key="settings" onclick="navigate('settings')">Cấu hình</button>
          <button class="tabbtn" data-key="account" onclick="navigate('account')">Cài đặt</button>
        </nav>

      </aside>

      <main class="content">
        <!-- ========== DASHBOARD ========== -->
        <section id="view-dashboard" class="view">
          <h2>Tổng quan</h2>

          <div id="dashboard_kpis" class="kpi-grid4">
            <div class="kpi-panel" data-kpi="fund">
              <div class="kpi-panel-title">Nguồn vốn</div>
              <div class="kpi-panel-body">
                <div class="kpi">
                  <div class="kpi-title">Quỹ vốn</div>
                  <div class="kpi-value" id="kpi_fund">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">Quỹ còn lại</div>
                  <div class="kpi-value" id="kpi_fund_left">0</div>
                </div>
              </div>
            </div>
            <div class="kpi-panel" data-kpi="cashflow">
              <div class="kpi-panel-title">Dòng tiền</div>
              <div class="kpi-panel-body">
                <div class="kpi">
                  <div class="kpi-title">Tổng số tiền vay</div>
                  <div class="kpi-value" id="kpi_amount">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">Gốc đã thu</div>
                  <div class="kpi-value" id="kpi_paid_goc">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">Lãi đã thu</div>
                  <div class="kpi-value" id="kpi_paid_lai">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">Phí đã thu</div>
                  <div class="kpi-value" id="kpi_paid_phi">0</div>
                </div>
              </div>
            </div>
            <div class="kpi-panel" data-kpi="customers">
              <div class="kpi-panel-title">Khách hàng</div>
              <div class="kpi-panel-body">
                <div class="kpi">
                  <div class="kpi-title">Tổng số KH</div>
                  <div class="kpi-value" id="kpi_cus_total">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">KH đang vay</div>
                  <div class="kpi-value" id="kpi_cus_active">0</div>
                </div>
              </div>
            </div>
            <div class="kpi-panel" data-kpi="loans">
              <div class="kpi-panel-title">Hợp đồng</div>
              <div class="kpi-panel-body">
                <div class="kpi">
                  <div class="kpi-title">Tổng số HĐ</div>
                  <div class="kpi-value" id="kpi_loans">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">HĐ active</div>
                  <div class="kpi-value">
                    <span id="kpi_loans_active" class="chip pulse green">0</span>
                  </div>
                </div>
                <div class="kpi">
                  <div class="kpi-title">HĐ inactive</div>
                  <div class="kpi-value" id="kpi_loans_inactive">0</div>
                </div>
              </div>
            </div>
          </div>
          <div id="dashboard_kpis_hidden" class="alert info hidden">KPI đang tắt. Vào tab <b>Cấu hình</b> để bật hiển thị.</div>

          <!-- Controls for “this week” sections -->
          <div class="dash-week">
            <div class="dash-week-head">
              <div class="dash-week-label">Hoạt động tuần này</div>
              <div class="dash-week-filter">
                <label for="dash_limit">Hiển thị</label>
                <select id="dash_limit" class="input">
                  <option value="5">5 gần nhất</option>
                  <option value="10">10 gần nhất</option>
                  <option value="20">20 gần nhất</option>
                </select>
                <button class="btn" onclick="loadDashboardWeekBlocks()">Áp dụng</button>
              </div>
            </div>

            <div class="dash-week-grid">
              <div class="card">
                <div class="card-head">Hợp đồng tạo trong tuần</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>Mã HĐ</th><th>Tên KH</th><th>Ngày</th><th>Số tiền</th><th>Trạng thái</th></tr></thead>
                    <tbody id="dash_loans_week"></tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <div class="card-head">Thanh toán trong tuần</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>Ngày</th><th>Mã HĐ</th><th>Loại</th><th>Số tiền</th></tr></thead>
                    <tbody id="dash_pays_week"></tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <div class="card-head">Đến hạn hôm nay</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>Mã HĐ</th><th>Tên KH</th><th>Kỳ</th><th>Đến hạn</th></tr></thead>
                    <tbody id="dash_due_today"></tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <div class="card-head">Tất toán hôm nay</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>Mã HĐ</th><th>Tên KH</th><th>Ngày tất toán</th><th>Trạng thái</th></tr></thead>
                    <tbody id="dash_close_today"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="card m24">
            <div class="card-head">Mô tả các chức năng chính</div>
            <div class="card-body">
              <p class="muted">Tổng hợp nhanh những gì bạn có thể làm trong hệ thống Web Quản Trị.</p>
              <div class="feature-grid">
                <div class="feature">
                  <div class="feature-title">Tổng quan</div>
                  <p>Theo dõi KPI tài chính, khách hàng và hợp đồng với khả năng tuỳ chỉnh hiển thị.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Khách hàng</div>
                  <p>Quản lý danh sách khách hàng, tìm kiếm, thêm mới và xem thông tin chi tiết.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Hợp đồng</div>
                  <p>Tra cứu các hợp đồng vay, lọc nhanh theo mã hoặc khách hàng và thực hiện cập nhật.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Khoản vay &amp; Thanh toán</div>
                  <p>Tạo phiếu thanh toán theo kỳ hoặc khoảng ngày, xem lịch kỳ sắp tới và ghi nhận giao dịch.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Lịch sử thanh toán</div>
                  <p>Xem lại toàn bộ giao dịch đã thu, lọc theo thời gian, loại tiền và hợp đồng.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">CRM</div>
                  <p>Lưu vết tương tác với khách hàng, quản lý công việc và chăm sóc qua nhiều kênh.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Nhóm Telegram</div>
                  <p>Điều phối thông báo và cấu hình nhóm trao đổi nội bộ ngay trong hệ thống.</p>
                </div>
                <div class="feature">
                  <div class="feature-title">Cấu hình &amp; Phân quyền</div>
                  <p>Tuỳ chỉnh KPI hiển thị, quản lý tài khoản đăng nhập và phân quyền truy cập theo nhu cầu.</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== CUSTOMERS ========== -->
        <section id="view-customers" class="view hidden">
          <h2>Khách hàng</h2>
          <div class="toolbar">
            <input id="cus_search" class="input" placeholder="Tìm ID/Tên/SĐT/Email..." />
            <button id="cus_btnSearch" class="btn">Tìm</button>
            <div class="spacer"></div>
            <button id="btn_new_customer" class="btn primary">Thêm KH</button>
          </div>

          <div id="cus_total" class="muted m8">—</div>
          <table class="tbl">
            <thead><tr>
              <th>ID Khách</th><th>Tên</th><th>SĐT</th><th>Email</th><th>Ghi chú</th>
            </tr></thead>
            <tbody id="cus_rows"></tbody>
          </table>
        </section>

        <!-- ========== LOANS ========== -->
        <section id="view-loans" class="view hidden">
          <h2>Hợp đồng</h2>
          <div class="toolbar">
            <input id="loan_search" class="input" placeholder="Tìm Mã HĐ/Tên KH/..." />
            <button id="loan_btnSearch" class="btn">Tìm</button>
            <div class="spacer"></div>
            <button id="btn_new_loan" class="btn primary">Thêm HĐ</button>
          </div>

          <div id="loan_total" class="muted m8">—</div>
          <table class="tbl">
            <thead><tr>
              <th>Mã HĐ</th><th>ID KH</th><th>Tên KH</th><th>PL KH</th><th>Hình thức</th>
              <th>Giải ngân</th><th>Kỳ hạn</th><th>Lãi %/th</th><th>Số tiền</th><th>Chu kỳ</th>
              <th>Tất toán</th><th>Trạng thái</th><th>Tạo</th><th>Cập nhật</th><th>Người sửa</th><th>Thao tác</th>
            </tr></thead>
            <tbody id="loan_rows"></tbody>
          </table>
        </section>

        <!-- ========== LOAN MANAGER / PAYMENTS ========== -->
        <section id="view-loanmgr" class="view hidden">
          <h2>Quản lý khoản vay / Thanh toán</h2>

          <div class="loanmgr-layout">
            <div class="loanmgr-left">
              <div class="card loanmgr-slip">
                <div class="card-head">Phiếu thanh toán</div>
                <div class="card-body">
                  <div class="slip-control">
                    <div class="slip-row">
                      <input id="slip_mahd" class="input" placeholder="Nhập Mã HĐ" />
                      <label for="slip_k_select">Kỳ</label>
                      <select id="slip_k_select" class="input">
                        <option value="">(Tự động)</option>
                      </select>
                      <button id="slip_btn" class="btn">Xem phiếu (kỳ)</button>
                    </div>
                    <div class="slip-row">
                      <label for="slip_from" class="slip-range-label">Theo khoảng ngày</label>
                      <input id="slip_from" type="date" class="input" />
                      <span class="slip-range-sep">—</span>
                      <input id="slip_to" type="date" class="input" />
                      <button id="slip_btn_range" class="btn">Xem phiếu (khoảng ngày)</button>
                    </div>
                  </div>

                  <div id="slip_card" class="slip-summary hideable">
                    <div class="slip-summary-head">
                      <div id="slip_title" class="slip-summary-title">Phiếu thanh toán</div>
                      <button id="slip_tg_btn" class="btn ghost">Gửi Telegram (ảnh)</button>
                    </div>
                    <div class="slip-summary-meta">
                      <div>
                        <div><span class="meta-label">Mã HĐ:</span> <span id="slip_id"></span></div>
                        <div><span class="meta-label">Tên KH:</span> <span id="slip_name"></span></div>
                        <div><span class="meta-label">Hình thức:</span> <span id="slip_type"></span></div>
                      </div>
                      <div>
                        <div><span class="meta-label">Kỳ:</span> <span id="slip_k"></span></div>
                        <div><span class="meta-label">Từ:</span> <span id="slip_from_txt"></span></div>
                        <div><span class="meta-label">Đến:</span> <span id="slip_to_txt"></span></div>
                      </div>
                    </div>
                    <div class="slip-summary-grid">
                      <div class="slip-summary-item">
                        <div class="title">Gốc đến hạn</div>
                        <div class="value" id="slip_goc_due">0</div>
                        <div class="muted">Đã thu: <span id="slip_goc_paid">0</span></div>
                      </div>
                      <div class="slip-summary-item">
                        <div class="title">Lãi đến hạn</div>
                        <div class="value" id="slip_lai_due">0</div>
                        <div class="muted">Đã thu: <span id="slip_lai_paid">0</span></div>
                      </div>
                      <div class="slip-summary-item">
                        <div class="title">Tổng</div>
                        <div class="value" id="slip_total_due">0</div>
                        <div class="muted">Đã thu: <span id="slip_total_paid">0</span></div>
                      </div>
                    </div>
                    <div class="slip-summary-footer">
                      Còn phải thu: <b id="slip_total_remain">0</b>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="loanmgr-right">
              <div class="card upcoming-card">
                <div class="card-head">Kỳ sắp tới (12 kỳ)</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>Kỳ</th><th>Đến hạn</th><th>Gốc</th><th>Lãi</th><th>Tổng</th></tr></thead>
                    <tbody id="upcoming_rows"></tbody>
                  </table>
                </div>
              </div>

              <div class="card pay-card">
                <div class="card-head">Thanh toán</div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-6">
                      <input id="pay_id" class="input" placeholder="PaymentID (để sửa/xoá)" />
                    </div>
                    <div class="col-6">
                      <input id="pay_loan" class="input" placeholder="Mã HĐ" />
                    </div>
                  </div>
                      <div class="row">
                        <div class="col-4 field">
                          <label for="pay_date">Ngày</label>
                          <input id="pay_date" type="date" class="input" />
                        </div>
                        <div class="col-4 field">
                          <label for="pay_type">Loại</label>
                          <select id="pay_type" class="input"></select>
                        </div>
                        <div class="col-4 field">
                          <label for="pay_amount">Số tiền</label>
                          <input id="pay_amount" class="input" />
                        </div>
                      </div>
                      <textarea id="pay_note" class="input" placeholder="Ghi chú"></textarea>
                    </div>
                    <div class="card-foot">
                      <button id="pay_clear" class="btn">Mới</button>
                      <button id="pay_save" class="btn primary">Lưu</button>
                      <button id="pay_delete" class="btn danger">Xoá</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- ========== PAY HISTORY ========== -->
        <section id="view-payhistory" class="view hidden">
          <h2>Lịch sử thanh toán</h2>

          <div class="card">
            <div class="card-head">Bộ lọc</div>
            <div class="card-body">
              <div class="toolbar">
                <input id="hist_mahd" class="input" placeholder="Mã HĐ (tuỳ chọn)" />
                <label>Từ ngày</label>
                <input id="hist_from" type="date" class="input" />
                <label>Đến ngày</label>
                <input id="hist_to" type="date" class="input" />
                <label>Loại</label>
                <select id="hist_type" class="input">
                  <option value="">Tất cả</option>
                  <option value="gốc">Gốc</option>
                  <option value="lãi">Lãi</option>
                  <option value="phí">Phí</option>
                </select>
                <button id="hist_load" class="btn">Tải lịch sử</button>
              </div>
              <div class="muted m8" id="hist_info">—</div>
            </div>
          </div>

          <div class="card m16">
            <div class="card-head">Chi tiết thanh toán</div>
            <div class="card-body">
              <table class="tbl">
                <thead><tr><th>Ngày</th><th>Mã HĐ</th><th>Loại</th><th>Số tiền</th><th>Ghi chú</th><th>PaymentID</th></tr></thead>
                <tbody id="hist_rows"></tbody>
              </table>
              <div class="muted m16" id="hist_sum">—</div>
            </div>
          </div>
        </section>

        <!-- ========== CRM ========== -->
        <section id="view-crm" class="view hidden">
          <h2>CRM</h2>
          <div class="crm-columns">
            <div class="crm-col">
              <div class="card">
                <div class="card-head">Nhật ký tương tác</div>
                <div class="card-body">
                  <input id="crm_interaction_id" type="hidden" />
                  <div class="row">
                    <div class="col-6 field">
                      <label for="crm_interaction_customer">ID Khách</label>
                      <input id="crm_interaction_customer" class="input" />
                    </div>
                    <div class="col-6 field">
                      <label for="crm_interaction_date">Ngày</label>
                      <input id="crm_interaction_date" type="date" class="input" />
                    </div>
                    <div class="col-6 field">
                      <label for="crm_interaction_channel">Kênh</label>
                      <input id="crm_interaction_channel" class="input" />
                    </div>
                    <div class="col-6 field">
                      <label for="crm_interaction_staff">Nhân viên</label>
                      <input id="crm_interaction_staff" class="input" />
                    </div>
                    <div class="col-12 field">
                      <label for="crm_interaction_tag">Tag</label>
                      <input id="crm_interaction_tag" class="input" />
                    </div>
                  </div>
                  <textarea id="crm_interaction_content" class="input" placeholder="Nội dung trao đổi..."></textarea>
                </div>
                <div class="card-foot">
                  <button id="crm_interaction_clear" class="btn">Làm mới</button>
                  <button id="crm_interaction_delete" class="btn danger">Xoá</button>
                  <div class="spacer"></div>
                  <button id="crm_interaction_save" class="btn primary">Lưu tương tác</button>
                </div>
              </div>

              <div class="card m16">
                <div class="card-head">Lịch sử tương tác</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>ID</th><th>ID Khách</th><th>Ngày</th><th>Kênh</th><th>Nhân viên</th><th>Tag</th><th>Nội dung</th><th></th></tr></thead>
                    <tbody id="crm_interaction_rows"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="crm-col">
              <div class="card">
                <div class="card-head">Công việc</div>
                <div class="card-body">
                  <input id="crm_task_id" type="hidden" />
                  <div class="row">
                    <div class="col-6 field">
                      <label for="crm_task_customer">ID Khách</label>
                      <input id="crm_task_customer" class="input" />
                    </div>
                    <div class="col-6 field">
                      <label for="crm_task_title">Tiêu đề</label>
                      <input id="crm_task_title" class="input" />
                    </div>
                    <div class="col-4 field">
                      <label for="crm_task_due">Hạn</label>
                      <input id="crm_task_due" type="date" class="input" />
                    </div>
                    <div class="col-4 field">
                      <label for="crm_task_status">Trạng thái</label>
                      <select id="crm_task_status" class="input">
                        <option value="Mới">Mới</option>
                        <option value="Đang xử lý">Đang xử lý</option>
                        <option value="Hoàn tất">Hoàn tất</option>
                      </select>
                    </div>
                    <div class="col-4 field">
                      <label for="crm_task_owner">Phụ trách</label>
                      <input id="crm_task_owner" class="input" />
                    </div>
                  </div>
                  <textarea id="crm_task_note" class="input" placeholder="Ghi chú"></textarea>
                </div>
                <div class="card-foot">
                  <button id="crm_task_clear" class="btn">Làm mới</button>
                  <button id="crm_task_delete" class="btn danger">Xoá</button>
                  <div class="spacer"></div>
                  <button id="crm_task_save" class="btn primary">Lưu công việc</button>
                </div>
              </div>

              <div class="card m16">
                <div class="card-head">Danh sách công việc</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>TaskID</th><th>ID Khách</th><th>Tiêu đề</th><th>Hạn</th><th>Trạng thái</th><th>Phụ trách</th><th>Ghi chú</th><th></th></tr></thead>
                    <tbody id="crm_task_rows"></tbody>
                  </table>
                </div>
              </div>

              <div class="card m16">
                <div class="card-head">Đánh giá khách hàng</div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-4 field">
                      <label for="crm_rating_customer">ID Khách</label>
                      <input id="crm_rating_customer" class="input" />
                    </div>
                    <div class="col-4 field">
                      <label for="crm_rating_score">Điểm</label>
                      <input id="crm_rating_score" class="input" />
                    </div>
                    <div class="col-4 field">
                      <label for="crm_rating_criteria">Tiêu chí</label>
                      <input id="crm_rating_criteria" class="input" />
                    </div>
                  </div>
                  <textarea id="crm_rating_note" class="input" placeholder="Nhận xét"></textarea>
                </div>
                <div class="card-foot">
                  <button id="crm_rating_save" class="btn primary">Lưu đánh giá</button>
                  <div class="spacer"></div>
                  <button id="crm_rating_reload" class="btn">Tải theo ID Khách</button>
                </div>
              </div>

              <div class="card m16">
                <div class="card-head">Lịch sử đánh giá</div>
                <div class="card-body">
                  <table class="tbl">
                    <thead><tr><th>ID Khách</th><th>Điểm</th><th>Tiêu chí</th><th>Nhận xét</th><th>Cập nhật</th></tr></thead>
                    <tbody id="crm_rating_rows"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== REPORTS ========== -->
        <section id="view-reports" class="view hidden">
          <h2>Báo cáo</h2>
          <div class="grid-3">
            <div class="card">
              <div class="card-head">Doanh thu theo tuần</div>
              <div class="card-body">
                <div class="muted">Placeholder — sẽ hoàn thiện biểu đồ/CSV sau.</div>
              </div>
            </div>
            <div class="card">
              <div class="card-head">Dư nợ theo trạng thái</div>
              <div class="card-body">
                <div class="muted">Placeholder.</div>
              </div>
            </div>
            <div class="card">
              <div class="card-head">Top khách hàng theo điểm CRM</div>
              <div class="card-body">
                <div class="muted">Placeholder.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== SETTINGS (kèm Import) ========== -->
        <section id="view-settings" class="view hidden">
          <!-- giữ nguyên nội dung như bạn gửi -->
          <h2>Cấu hình</h2>
          <div class="card">
            <div class="card-head">Thiết lập chung</div>
            <div class="card-body">
              <div class="row">
                <div class="col-6 field">
                  <label for="cfg_fund">Quỹ vốn</label>
                  <input id="cfg_fund" class="input" />
                </div>
                <div class="col-6 field">
                  <label for="cfg_paytypes">Loại thanh toán</label>
                  <input id="cfg_paytypes" class="input" placeholder="gốc,lãi,phí" />
                </div>
              </div>
              <div class="m12">
                <label class="checkbox-inline">
                  <input id="cfg_show_kpi" type="checkbox" />
                  <span>Hiển thị KPI trên trang Tổng quan</span>
                </label>
              </div>
              <div class="kpi-config-wrap">
                <div class="sub-title">KPI hiển thị</div>
                <div class="muted">Bật/tắt từng KPI và dùng mũi tên để sắp xếp thứ tự hiển thị ở trang Tổng quan.</div>
                <div id="kpi_config_list" class="kpi-config-list"></div>
              </div>
            </div>
            <div class="card-foot">
              <button id="cfg_save" class="btn primary">Lưu cấu hình</button>
            </div>
          </div>

          <div class="card">
            <div class="card-head">Import / Update từ Google Sheets</div>
            <div class="card-body">
              <div class="row">
                <div class="col-6 field">
                  <label for="imp_file">Drive File ID</label>
                  <input id="imp_file" class="input" placeholder="1aBcD..." />
                </div>
                <div class="col-6 field">
                  <label for="imp_sheet">Sheet name (tùy chọn)</label>
                  <input id="imp_sheet" class="input" placeholder="Tên sheet (nếu có)" />
                </div>
              </div>
              <div class="row">
                <div class="col-4 field">
                  <label for="imp_table">Bảng đích</label>
                  <select id="imp_table" class="input">
                    <option value="CUSTOMERS">CUSTOMERS (KHÁCH HÀNG)</option>
                    <option value="LOANS">LOANS (HỢP ĐỒNG)</option>
                    <option value="PAYMENTS">PAYMENTS (THANH TOÁN)</option>
                  </select>
                </div>
                <div class="col-4 field">
                  <label for="imp_mode">Chế độ</label>
                  <select id="imp_mode" class="input">
                    <option value="upsert">Upsert theo ID</option>
                    <option value="append">Append</option>
                  </select>
                </div>
                <div class="col-4 field">
                  <label>&nbsp;</label>
                  <button id="imp_run" class="btn">Chạy Import</button>
                </div>
              </div>
              <div class="muted m8">
                File nguồn cần có header trùng tên cột đích (ví dụ “Mã HĐ”, “ID Khách”, “Số tiền”…).
              </div>
            </div>
          </div>
        </section>

        <!-- ========== TELEGRAM ========== -->
        <section id="view-telegram" class="view hidden">
          <!-- giữ nguyên block Telegram như bạn gửi -->
          <h2>Quản lý Telegram</h2>
          <div class="card">
            <div class="card-head">Bot & Chat mặc định</div>
            <div class="card-body">
              <div class="muted">
                Bot và Chat mặc định cấu hình ở tab <b>Cấu hình</b> (TG_BOT / TG_CHAT). Ở đây bạn có thể quản lý <b>nhiều nhóm</b> để gửi nhanh.
              </div>
            </div>
          </div>
          <div class="grid-2 tg-columns">
            <div class="card">
              <div class="card-head">Danh sách nhóm</div>
              <div class="card-body">
                <table class="tbl">
                  <thead><tr><th>Tên</th><th>chat_id</th><th>Mục đích</th><th></th></tr></thead>
                  <tbody id="tg_rows"></tbody>
                </table>
              </div>
            </div>
            <div class="tg-stack">
              <div class="card">
                <div class="card-head">Thêm nhóm</div>
                <div class="card-body">
                  <input id="tg_name" class="input" placeholder="Tên nhóm" />
                  <input id="tg_chat" class="input" placeholder="chat_id" />
                  <input id="tg_purpose" class="input" placeholder="Mục đích (ví dụ: nhắc việc, phiếu...)" />
                </div>
                <div class="card-foot">
                  <button class="btn primary" onclick="tgAddGroup()">Thêm</button>
                </div>
              </div>
              <div class="card">
                <div class="card-head">Gửi thử</div>
                <div class="card-body">
                  <div class="field">
                    <label for="tg_sel">Chọn nhóm</label>
                    <select id="tg_sel" class="input"></select>
                  </div>
                  <textarea id="tg_text" class="input" placeholder="Nội dung tin nhắn..."></textarea>
                </div>
                <div class="card-foot">
                  <button class="btn" onclick="tgSendText()">Gửi text</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== ACCOUNT ========== -->
        <section id="view-account" class="view hidden">
          <!-- giữ nguyên block Account -->
          <h2>Cài đặt tài khoản</h2>
          <div class="grid-2">
            <div class="card">
              <div class="card-head">Hiển thị</div>
              <div class="card-body">
                <div class="field">
                  <label for="acct_timefmt">Định dạng thời gian</label>
                  <input id="acct_timefmt" class="input" />
                </div>
                <div class="field">
                  <label for="acct_font">Font</label>
                  <input id="acct_font" class="input" />
                </div>
              </div>
              <div class="card-foot">
                <button id="acct_saveprefs" class="btn primary">Lưu</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">Đổi mật khẩu (tài khoản nội bộ)</div>
              <div class="card-body">
                <input id="acct_old" class="input" type="password" placeholder="Mật khẩu hiện tại" />
                <input id="acct_new" class="input" type="password" placeholder="Mật khẩu mới" />
              </div>
              <div class="card-foot">
                <button id="acct_chpass" class="btn primary">Đổi mật khẩu</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== DIALOGS (popup giữ nguyên) ========== -->
        <!-- Add/Edit Customer -->
        <dialog id="dlg_customer" class="modal">
          <div class="box">
            <div class="head">Khách hàng</div>
            <div class="body">
              <div class="field">
                <label for="dlg_cus_id">ID Khách (để trống nếu tạo mới)</label>
                <input id="dlg_cus_id" />
              </div>
              <div class="field">
                <label for="dlg_cus_name">Tên</label>
                <input id="dlg_cus_name" />
              </div>
              <div class="field">
                <label for="dlg_cus_phone">SĐT</label>
                <input id="dlg_cus_phone" />
              </div>
              <div class="field">
                <label for="dlg_cus_email">Email</label>
                <input id="dlg_cus_email" />
              </div>
              <div class="field">
                <label for="dlg_cus_note">Ghi chú</label>
                <textarea id="dlg_cus_note"></textarea>
              </div>
            </div>
            <div class="foot">
              <button class="btn" onclick="document.getElementById('dlg_customer').close()">Đóng</button>
              <button id="dlg_cus_save" class="btn primary">Lưu</button>
            </div>
          </div>
        </dialog>

        <!-- Add/Edit Loan -->
        <dialog id="dlg_loan" class="modal">
          <div class="box">
            <div class="head">Hợp đồng</div>
            <div class="body">
              <div class="row">
                <div class="col-6 field">
                  <label for="dlg_loan_id">Mã HĐ</label>
                  <input id="dlg_loan_id" />
                </div>
                <div class="col-6 field">
                  <label for="dlg_loan_plkh">PL KH</label>
                  <input id="dlg_loan_plkh" />
                </div>
              </div>
              <div class="row">
                <div class="col-6 field">
                  <label for="dlg_loan_cus_select">Khách hàng</label>
                  <select id="dlg_loan_cus_select"></select>
                </div>
                <div class="col-6 field">
                  <label for="dlg_loan_cusid">ID Khách (nếu không chọn ở dropdown)</label>
                  <input id="dlg_loan_cusid" placeholder="ID Khách (nếu không chọn ở dropdown)" />
                </div>
              </div>
              <div class="row">
                <div class="col-3 field">
                  <label for="dlg_loan_type">Hình thức</label>
                  <select id="dlg_loan_type">
                    <option>Cuốn chiếu</option>
                    <option>Cuối kỳ</option>
                  </select>
                </div>
                <div class="col-3 field">
                  <label for="dlg_loan_amount">Số tiền</label>
                  <input id="dlg_loan_amount" />
                </div>
                <div class="col-3 field">
                  <label for="dlg_loan_rate">Lãi %/th</label>
                  <input id="dlg_loan_rate" />
                </div>
                <div class="col-3 field">
                  <label for="dlg_loan_months">Kỳ hạn (tháng)</label>
                  <input id="dlg_loan_months" />
                </div>
              </div>
              <div class="row">
                <div class="col-6 field">
                  <label for="dlg_loan_start">Giải ngân</label>
                  <input id="dlg_loan_start" type="date" />
                </div>
                <div class="col-6 field">
                  <label for="dlg_loan_close">Tất toán</label>
                  <input id="dlg_loan_close" type="date" />
                </div>
              </div>
            </div>
            <div class="foot">
              <button class="btn" onclick="document.getElementById('dlg_loan').close()">Đóng</button>
              <button id="dlg_loan_save" class="btn primary">Lưu</button>
            </div>
          </div>
        </dialog>
      </main>
    </div>

    <div id="dlg_login" class="modal modal-overlay">
      <div class="box">
        <div class="head">
          <div class="title">Đăng nhập tài khoản nội bộ</div>
        </div>
        <div class="body">
          <div class="field">
            <label for="login_user">Tài khoản</label>
            <input id="login_user" class="input" type="text" autocomplete="username" />
          </div>
          <div class="field">
            <label for="login_pass">Mật khẩu</label>
            <input id="login_pass" class="input" type="password" autocomplete="current-password" />
          </div>
          <div class="muted" style="margin-top:8px">
            Bạn cũng có thể đăng nhập Google (nếu email của bạn nằm trong danh sách cho phép).
          </div>
        </div>
        <div class="foot">
          <button class="btn" type="button" onclick="closeLoginDialog()">Đóng</button>
          <button class="btn primary" type="button" id="btn_login_do">Đăng nhập</button>
        </div>
      </div>
    </div>
    <?!= include('cms_scripts'); ?>
  </body>
</html>
